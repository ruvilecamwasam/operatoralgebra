(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 12.3' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[    234470,       5785]
NotebookOptionsPosition[    229585,       5694]
NotebookOutlinePosition[    230018,       5711]
CellTagsIndexPosition[    229975,       5708]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["OperatorAlgebra v2", "Title",
 CellChangeTimes->{{3.934157878887951*^9, 
  3.934157880803322*^9}},ExpressionUUID->"36657420-c6b4-2e4b-8cad-\
d0e8ee672813"],

Cell[TextData[{
 "Joseph J. Hope & Ruvi Lecamwasam\nVersion 2, 1st September 2024\n\nTo load \
OperatorAlgebra, run this entire notebook. ",
 ButtonBox["See the website",
  BaseStyle->"Hyperlink",
  ButtonData->{
    URL["https://github.com/ruvilecamwasam/operatoralgebra"], None},
  ButtonNote->"https://github.com/ruvilecamwasam/operatoralgebra"],
 " for documentation and examples."
}], "Text",
 CellChangeTimes->{{3.9341574704174595`*^9, 3.93415748052335*^9}, {
  3.934157522905676*^9, 3.9341575641128464`*^9}, {3.9341576313786583`*^9, 
  3.934157632525869*^9}, {3.9341578899432907`*^9, 
  3.934157918892906*^9}},ExpressionUUID->"c959c9c9-15f9-664c-9757-\
80c5fe998eba"],

Cell[CellGroupData[{

Cell["Base", "Section",
 CellChangeTimes->{{3.8943417885568914`*^9, 3.8943417904944506`*^9}, {
  3.93415758613183*^9, 
  3.9341575878066845`*^9}},ExpressionUUID->"f6d4f324-b6b9-4880-85ed-\
5063cb5c18b3"],

Cell["\<\
This is the original OperatorAlgebra package. It lets you define operators, \
and describes how symbolic algebra with these should function.\
\>", "Text",
 CellChangeTimes->{{3.894341805246689*^9, 3.894341835758622*^9}, {
  3.899181890638295*^9, 3.899181894480035*^9}, {3.923592373421614*^9, 
  3.92359238787142*^9}, {3.934157501540095*^9, 3.934157502643461*^9}, {
  3.934157533187139*^9, 3.9341575356693344`*^9}, {3.934157574939615*^9, 
  3.9341576090045147`*^9}, {3.934157643768881*^9, 3.934157646576088*^9}, {
  3.934157687249237*^9, 
  3.934157711587511*^9}},ExpressionUUID->"dfe74e1f-de29-4b06-8693-\
4d33c8ae87c9"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Needs", "[", "\"\<Notation`\>\"", "]"}]], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 InitializationGroup->True,
 CellChangeTimes->{
  3.521402170753628*^9, {3.569537978044776*^9, 3.569537992655091*^9}, 
   3.56953803009528*^9},
 CellLabel->"In[1]:=",ExpressionUUID->"f56180c4-964e-411a-858f-bd7682b56cf3"],

Cell[BoxData[{
 RowBox[{"Notation", "[", 
  RowBox[{
   TemplateBox[{
     TagBox[
      SubscriptBox[
       OverscriptBox["a_", "^"], "b_"], "NotationTemplateTag"]},
    "NotationTemplateTag"], " ", "\[DoubleLongLeftRightArrow]", " ", 
   TemplateBox[{
     RowBox[{"Operator", "[", 
       RowBox[{"a_", ",", "b_"}], "]"}]},
    "NotationTemplateTag"]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"Notation", "[", 
  RowBox[{
   TagBox[
    OverscriptBox["a_", "^"],
    "NotationTemplateTag"], " ", "\[DoubleLongLeftRightArrow]", " ", 
   TagBox[
    RowBox[{"Operator", "[", "a_", "]"}],
    "NotationTemplateTag",
    BaseStyle->"NotationTemplateStyle",
    Editable->True]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"Notation", "[", 
  RowBox[{
   TemplateBox[{
     TemplateBox[{"a_"}, "Ket"]},
    "NotationTemplateTag"], "\[DoubleLongLeftRightArrow]", " ", 
   TagBox[
    RowBox[{"Operator", "[", 
     RowBox[{"ket", ",", "a_"}], "]"}],
    "NotationTemplateTag",
    BaseStyle->"NotationTemplateStyle",
    Editable->True]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"Notation", "[", 
  RowBox[{
   TemplateBox[{
     TemplateBox[{"a_"}, "Bra"]},
    "NotationTemplateTag"], "\[DoubleLongLeftRightArrow]", " ", 
   TagBox[
    RowBox[{"Operator", "[", 
     RowBox[{"bra", ",", "a_"}], "]"}],
    "NotationTemplateTag",
    BaseStyle->"NotationTemplateStyle",
    Editable->True]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Subscript", "[", 
    RowBox[{
     RowBox[{"Operator", "[", "a_", "]"}], ",", "b_"}], "]"}], ":=", 
   RowBox[{"Operator", "[", 
    RowBox[{"a", ",", "b"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"InfixNotation", "[", 
   RowBox[{
    TagBox["\[SmallCircle]",
     "NotationTemplateTag"], ",", "op"}], "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Clear", "[", "op", "]"}], "\[IndentingNewLine]", 
 RowBox[{"SetAttributes", "[", 
  RowBox[{"op", ",", "Listable"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    RowBox[{"op", "[", "b__", "]"}]}], "]"}], ":=", 
  RowBox[{"op", "[", 
   RowBox[{"a", ",", "b"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{
    RowBox[{"op", "[", "a__", "]"}], ",", "b__"}], "]"}], ":=", 
  RowBox[{"op", "[", 
   RowBox[{"a", ",", "b"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", "a_", "]"}], ":=", "a"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    RowBox[{"op", "[", 
     RowBox[{"b_", ",", "c__"}], "]"}], ",", "d__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"a", ",", "b", ",", "c", ",", "d"}], "]"}], "/;", 
   RowBox[{
    RowBox[{"FreeQ", "[", 
     RowBox[{"b", ",", "Operator"}], "]"}], "\[Equal]", 
    "False"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a_", ",", "b__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"a", " ", 
    RowBox[{"op", "[", "b", "]"}]}], " ", "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"a", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", "b_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"op", "[", "a", "]"}], " ", "b"}], " ", "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"b", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", "b_", ",", "c__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "c"}], "]"}], " ", "b"}], " ", "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"b", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"c__", ",", 
    FractionBox["a_", "r_"], ",", "b__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    FractionBox["1", "r"], 
    RowBox[{"op", "[", 
     RowBox[{"c", ",", "a", ",", "b"}], "]"}]}], "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"r", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    FractionBox["b_", "r_"]}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    FractionBox["1", "r"], 
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "b"}], "]"}]}], "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"r", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{
    FractionBox["b_", "r_"], ",", "a__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    FractionBox["1", "r"], 
    RowBox[{"op", "[", 
     RowBox[{"b", ",", "a"}], "]"}]}], "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"r", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{
    RowBox[{"r_", " ", "a_"}], ",", "b__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"r", " ", 
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "b"}], "]"}]}], "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"r", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{
    RowBox[{"a_", " ", "r_"}], ",", "b__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"r", " ", 
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "b"}], "]"}]}], "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"r", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    RowBox[{"r_", " ", "b_"}]}], "]"}], ":=", 
  RowBox[{
   RowBox[{"r", " ", 
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "b"}], "]"}]}], "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"r", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    RowBox[{"b_", " ", "r_"}]}], "]"}], ":=", 
  RowBox[{
   RowBox[{"r", " ", 
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "b"}], "]"}]}], "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"r", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    RowBox[{"r_", " ", "b_"}], ",", "c__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"r", " ", 
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "b", ",", "c"}], "]"}]}], "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"r", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    RowBox[{"b_", " ", "r_"}], ",", "c__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"r", " ", 
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "b", ",", "c"}], "]"}]}], "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"r", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{
    RowBox[{"r_", " ", "+", " ", "a_"}], ",", "b__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"r", ",", "b"}], "]"}], "+", 
   RowBox[{"op", "[", 
    RowBox[{"a", ",", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{
    RowBox[{"r_", " ", "-", " ", "a_"}], ",", "b__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"r", ",", "b"}], "]"}], "-", 
   RowBox[{"op", "[", 
    RowBox[{"a", ",", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"r__", ",", " ", 
    RowBox[{"a_", " ", "+", " ", "b_"}]}], "]"}], ":=", 
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"r", ",", "a"}], "]"}], "+", 
   RowBox[{"op", "[", 
    RowBox[{"r", ",", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"r__", " ", ",", " ", 
    RowBox[{"a_", "-", " ", "b_"}]}], "]"}], ":=", 
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"r", ",", "a"}], "]"}], "-", 
   RowBox[{"op", "[", 
    RowBox[{"r", ",", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"r__", ",", " ", 
    RowBox[{"a_", " ", "+", " ", "b_"}], ",", "c__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"r", ",", "a", ",", "c"}], "]"}], "+", 
   RowBox[{"op", "[", 
    RowBox[{"r", ",", "b", ",", "c"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"r__", " ", ",", " ", 
     RowBox[{"a_", "-", " ", "b_"}], ",", "c__"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"op", "[", 
     RowBox[{"r", ",", "a", ",", "c"}], "]"}], "-", 
    RowBox[{"op", "[", 
     RowBox[{"r", ",", "b", ",", "c"}], "]"}]}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"\[LeftAngleBracket]", "b__", "\[RightAngleBracket]"}], "]"}], ":=", 
  RowBox[{
  "\[LeftAngleBracket]", "b", 
   "\[RightAngleBracket]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{
     RowBox[{"\[LeftAngleBracket]", "a_", "\[RightAngleBracket]"}], ",", 
     "b__"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"\[LeftAngleBracket]", "a", "\[RightAngleBracket]"}], " ", 
    RowBox[{"op", "[", "b", "]"}]}]}], " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"a__", ",", 
     RowBox[{"\[LeftAngleBracket]", "b_", "\[RightAngleBracket]"}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{"op", "[", "a", "]"}], " ", 
    RowBox[{"\[LeftAngleBracket]", "b", "\[RightAngleBracket]"}]}]}], 
  " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"a__", ",", 
     RowBox[{"\[LeftAngleBracket]", "b_", "\[RightAngleBracket]"}], ",", 
     "c__"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "c"}], "]"}], " ", 
    RowBox[{"\[LeftAngleBracket]", "b", "\[RightAngleBracket]"}]}]}], 
  " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"c__", ",", 
    FractionBox["a_", 
     RowBox[{"\[LeftAngleBracket]", "r_", "\[RightAngleBracket]"}]], ",", 
    "b__"}], "]"}], ":=", 
  RowBox[{
   FractionBox["1", 
    RowBox[{"\[LeftAngleBracket]", "r", "\[RightAngleBracket]"}]], 
   RowBox[{"op", "[", 
    RowBox[{"c", ",", "a", ",", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    FractionBox["b_", 
     RowBox[{"\[LeftAngleBracket]", "r_", "\[RightAngleBracket]"}]]}], "]"}], 
  ":=", 
  RowBox[{
   FractionBox["1", 
    RowBox[{"\[LeftAngleBracket]", "r", "\[RightAngleBracket]"}]], 
   RowBox[{"op", "[", 
    RowBox[{"a", ",", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{
    FractionBox["b_", 
     RowBox[{"\[LeftAngleBracket]", "r_", "\[RightAngleBracket]"}]], ",", 
    "a__"}], "]"}], ":=", 
  RowBox[{
   FractionBox["1", 
    RowBox[{"\[LeftAngleBracket]", "r", "\[RightAngleBracket]"}]], 
   RowBox[{"op", "[", 
    RowBox[{"b", ",", "a"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{
    RowBox[{"\[LeftAngleBracket]", "r_", "\[RightAngleBracket]"}], " ", 
    "a_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"\[LeftAngleBracket]", "r", "\[RightAngleBracket]"}], " ", 
   RowBox[{"op", "[", "a", "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"\[LeftAngleBracket]", "r_", "\[RightAngleBracket]"}], " ", 
     "a_"}], ",", "b__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"\[LeftAngleBracket]", "r", "\[RightAngleBracket]"}], " ", 
   RowBox[{"op", "[", 
    RowBox[{"a", ",", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{
    RowBox[{"a_", " ", 
     RowBox[{"\[LeftAngleBracket]", "r_", "\[RightAngleBracket]"}]}], ",", 
    "b__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"\[LeftAngleBracket]", "r", "\[RightAngleBracket]"}], " ", 
   RowBox[{"op", "[", 
    RowBox[{"a", ",", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    RowBox[{
     RowBox[{"\[LeftAngleBracket]", "r_", " ", "\[RightAngleBracket]"}], 
     "b_"}]}], "]"}], ":=", 
  RowBox[{
   RowBox[{"\[LeftAngleBracket]", "r", "\[RightAngleBracket]"}], " ", 
   RowBox[{"op", "[", 
    RowBox[{"a", ",", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    RowBox[{"b_", " ", 
     RowBox[{"\[LeftAngleBracket]", "r_", "\[RightAngleBracket]"}]}]}], "]"}],
   ":=", 
  RowBox[{
   RowBox[{"\[LeftAngleBracket]", "r", "\[RightAngleBracket]"}], " ", 
   RowBox[{"op", "[", 
    RowBox[{"a", ",", "b"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"op", "[", 
   RowBox[{"a__", ",", 
    RowBox[{
     RowBox[{"\[LeftAngleBracket]", "r_", "\[RightAngleBracket]"}], " ", 
     "b_"}], ",", "c__"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"\[LeftAngleBracket]", "r", "\[RightAngleBracket]"}], " ", 
   RowBox[{"op", "[", 
    RowBox[{"a", ",", "b", ",", "c"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"a__", ",", 
     RowBox[{"b_", " ", 
      RowBox[{"\[LeftAngleBracket]", "r_", "\[RightAngleBracket]"}]}], ",", 
     "c__"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"\[LeftAngleBracket]", "r", "\[RightAngleBracket]"}], " ", 
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "b", ",", "c"}], "]"}]}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[LeftAngleBracket]", 
   RowBox[{
    RowBox[{"\[LeftAngleBracket]", "a_", "\[RightAngleBracket]"}], " ", 
    "b_"}], "\[RightAngleBracket]"}], ":=", 
  RowBox[{
   RowBox[{"\[LeftAngleBracket]", "a", "\[RightAngleBracket]"}], 
   RowBox[{
   "\[LeftAngleBracket]", "b", 
    "\[RightAngleBracket]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[LeftAngleBracket]", 
   RowBox[{"a_", " ", "b_"}], "\[RightAngleBracket]"}], ":=", 
  RowBox[{
   RowBox[{"a", " ", 
    RowBox[{"\[LeftAngleBracket]", "b", "\[RightAngleBracket]"}]}], " ", "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"a", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[LeftAngleBracket]", 
   RowBox[{"b_", " ", "a_"}], "\[RightAngleBracket]"}], ":=", 
  RowBox[{
   RowBox[{"a", " ", 
    RowBox[{"\[LeftAngleBracket]", "b", "\[RightAngleBracket]"}]}], " ", "/;", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"a", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[LeftAngleBracket]", 
    RowBox[{"a_", " ", "+", "b_"}], "\[RightAngleBracket]"}], ":=", 
   RowBox[{
    RowBox[{"\[LeftAngleBracket]", "a", "\[RightAngleBracket]"}], "+", 
    RowBox[{"\[LeftAngleBracket]", "b", "\[RightAngleBracket]"}]}]}], 
  " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[LeftAngleBracket]", 
    RowBox[{"a_", " ", "-", "b_"}], "\[RightAngleBracket]"}], ":=", 
   RowBox[{
    RowBox[{"\[LeftAngleBracket]", "a", "\[RightAngleBracket]"}], "-", 
    RowBox[{"\[LeftAngleBracket]", "b", "\[RightAngleBracket]"}]}]}], 
  " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"\[LeftAngleBracket]", "a_", "\[RightAngleBracket]"}], ":=", 
   RowBox[{"a", "  ", "/;", 
    RowBox[{"NumberQ", "[", "a", "]"}]}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"pow", "[", 
    RowBox[{"a_", ",", "n_"}], "]"}], ":=", 
   RowBox[{"If", "[", 
    RowBox[{
     RowBox[{"n", "\[Equal]", "0"}], ",", "1", ",", 
     RowBox[{"op", "[", 
      RowBox[{
       RowBox[{"pow", "[", 
        RowBox[{"a", ",", 
         RowBox[{"n", "-", "1"}]}], "]"}], ",", "a"}], "]"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Clear", "[", "SuperDagger", "]"}], "\[IndentingNewLine]", 
 RowBox[{"SetAttributes", "[", 
  RowBox[{"SuperDagger", ",", "Listable"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SuperDagger", "[", 
   RowBox[{"a_", " ", "+", " ", "b_"}], "]"}], ":=", " ", 
  RowBox[{
   RowBox[{"SuperDagger", "[", "a", "]"}], " ", "+", " ", 
   RowBox[{"SuperDagger", "[", "b", "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SuperDagger", "[", 
    RowBox[{"a_", " ", "b_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"SuperDagger", "[", "a", "]"}], " ", 
    RowBox[{"SuperDagger", "[", "b", "]"}]}]}], " "}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SuperDagger", "[", "a_", "]"}], ":=", 
  RowBox[{
   RowBox[{"Conjugate", "[", "a", "]"}], "/;", " ", 
   RowBox[{"FreeQ", "[", 
    RowBox[{"a", ",", "Operator"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SuperDagger", "[", "a_", "]"}], ":=", 
  RowBox[{
   RowBox[{"Part", "[", 
    RowBox[{"a", ",", "1"}], "]"}], "/;", 
   RowBox[{
    RowBox[{"Head", "[", "a", "]"}], "\[Equal]", 
    "SuperDagger"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SuperDagger", "[", "a_", "]"}], " ", ":=", 
  RowBox[{
   RowBox[{"Apply", "[", 
    RowBox[{"op", ",", 
     RowBox[{"Reverse", "[", 
      RowBox[{"SuperDagger", "[", 
       RowBox[{"Level", "[", 
        RowBox[{"a", ",", "1"}], "]"}], "]"}], "]"}]}], "]"}], "/;", 
   RowBox[{
    RowBox[{"Head", "[", "a", "]"}], "\[Equal]", 
    "op"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"SuperDagger", "[", 
    RowBox[{"\[LeftAngleBracket]", "b__", "\[RightAngleBracket]"}], "]"}], ":=", 
   RowBox[{"\[LeftAngleBracket]", 
    RowBox[{"SuperDagger", "[", "b", "]"}], "\[RightAngleBracket]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SuperDagger", "[", 
   RowBox[{"Operator", "[", 
    RowBox[{"bra", ",", "a_"}], "]"}], "]"}], ":=", 
  RowBox[{"Operator", "[", 
   RowBox[{"ket", ",", "a"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SuperDagger", "[", 
   RowBox[{"Operator", "[", 
    RowBox[{"ket", ",", "a_"}], "]"}], "]"}], ":=", 
  RowBox[{"Operator", "[", 
   RowBox[{"bra", ",", "a"}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Unprotect", "[", "Conjugate", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Conjugate", "[", 
   RowBox[{"KroneckerDelta", "[", "a__", "]"}], "]"}], ":=", 
  RowBox[{"KroneckerDelta", "[", "a", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Conjugate", "[", 
   RowBox[{"\[LeftAngleBracket]", "b__", "\[RightAngleBracket]"}], "]"}], ":=", 
  RowBox[{"\[LeftAngleBracket]", 
   RowBox[{"SuperDagger", "[", "b", "]"}], 
   "\[RightAngleBracket]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Protect", "[", "Conjugate", "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"co", "[", 
   RowBox[{"a_", ",", "b_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"a", ",", "b"}], "]"}], "-", 
   RowBox[{"op", "[", 
    RowBox[{"b", ",", "a"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"aco", "[", 
    RowBox[{"a_", ",", "b_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"op", "[", 
     RowBox[{"a", ",", "b"}], "]"}], "+", 
    RowBox[{"op", "[", 
     RowBox[{"b", ",", "a"}], "]"}]}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"pattClean", "[", "dd_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "ddummy", "}"}], ",", 
     RowBox[{
      RowBox[{"dd", "/.", 
       RowBox[{"{", 
        RowBox[{"Pattern", "\[Rule]", "ddummy"}], "}"}]}], "/.", 
      RowBox[{
       RowBox[{"ddummy", "[", 
        RowBox[{"c_", ",", "d_"}], "]"}], "\[Rule]", "c"}]}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Commutator", "[", 
   RowBox[{"a_", ",", "b_", ",", "c_"}], "]"}], ":=", 
  RowBox[{"With", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"pa", "=", 
       RowBox[{"pattClean", "[", "a", "]"}]}], ",", 
      RowBox[{"pb", "=", 
       RowBox[{"pattClean", "[", "b", "]"}]}], ",", 
      RowBox[{"aa", "=", "a"}], ",", 
      RowBox[{"bb", "=", "b"}]}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"aa", ",", "bb"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"pb", ",", "pa"}], "]"}], "+", "c"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n1__", ",", "aa", ",", "bb"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n1", ",", "pb", ",", "pa"}], "]"}], "+", 
       RowBox[{"op", "[", 
        RowBox[{"n1", ",", "c"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"aa", ",", "bb", ",", "m1__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"pb", ",", "pa", ",", "m1"}], "]"}], "+", 
       RowBox[{"op", "[", 
        RowBox[{"c", ",", "m1"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n1__", ",", "aa", ",", "bb", ",", "m1__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n1", ",", "pb", ",", "pa", ",", "m1"}], "]"}], "+", 
       RowBox[{"op", "[", 
        RowBox[{"n1", ",", "c", ",", "m1"}], "]"}]}]}], ";"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Commutator", "::", "usage"}], "=", 
    "\"\<Commutator[\!\(\*OverscriptBox[StyleBox[\"a\",FontSlant->\"Italic\"],\
 \"^\"]\)\!\(\*StyleBox[\"_\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\",\",\
FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[StyleBox[\"b\",FontSlant->\"\
Italic\"], \
\"^\"]\)\!\(\*StyleBox[\"_\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\",\",\
FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[StyleBox[\"c\",FontSlant->\"\
Italic\"], \"^\"]\)\!\(\*StyleBox[\"_\",FontSlant->\"Italic\"]\)] creates the \
commutation relation [\!\(\*OverscriptBox[\(a\), \
\(^\)]\),\!\(\*OverscriptBox[\(b\), \(^\)]\)]=\!\(\*OverscriptBox[\(c\), \
\(^\)]\). This means that whenever the product \!\(\*OverscriptBox[\(a\), \(^\
\)]\)\[SmallCircle]\!\(\*OverscriptBox[\(b\), \(^\)]\) occurs, it will be \
replaced by \!\(\*OverscriptBox[\(b\), \
\(^\)]\)\[SmallCircle]\!\(\*OverscriptBox[\(a\), \
\(^\)]\)+\!\(\*OverscriptBox[\(c\), \(^\)]\). \n* \
Commutator[\!\(\*OverscriptBox[StyleBox[\"a\",FontSlant->\"Italic\"], \
\"^\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[\
StyleBox[\"b\",FontSlant->\"Italic\"], \
\"^\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[\
StyleBox[\"c\",FontSlant->\"Italic\"], \"^\"]\)] and \
Commutator[\!\(\*OverscriptBox[StyleBox[\"b\",FontSlant->\"Italic\"], \
\"^\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[\
StyleBox[\"a\",FontSlant->\"Italic\"], \
\"^\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"-\",\
FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[StyleBox[\"c\",FontSlant->\"\
Italic\"], \"^\"]\)] do NOT do the same thing. \
Commutator[\!\(\*OverscriptBox[StyleBox[\"a\",FontSlant->\"Italic\"], \
\"^\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[\
StyleBox[\"b\",FontSlant->\"Italic\"], \
\"^\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[\
StyleBox[\"c\",FontSlant->\"Italic\"], \"^\"]\)] means all equations will be \
rearranged to contain the ordering \!\(\*OverscriptBox[\(b\), \(^\)]\)\
\[SmallCircle]\!\(\*OverscriptBox[\(a\), \(^\)]\), while \
Commutator[\!\(\*OverscriptBox[StyleBox[\"b\",FontSlant->\"Italic\"], \
\"^\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[\
StyleBox[\"a\",FontSlant->\"Italic\"], \
\"^\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"-\",\
FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[StyleBox[\"c\",FontSlant->\"\
Italic\"], \"^\"]\)] imposes the ordering \!\(\*OverscriptBox[\(a\), \(^\)]\)\
\[SmallCircle]\!\(\*OverscriptBox[\(b\), \(^\)]\).\n* If you run both \
Commutator[\!\(\*OverscriptBox[StyleBox[\"a\",FontSlant->\"Italic\"], \
\"^\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[\
StyleBox[\"b\",FontSlant->\"Italic\"], \
\"^\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*OverscriptBox[\
StyleBox[\"c\",FontSlant->\"Italic\"], \"^\"]\)] and \
Commutator[\!\(\*OverscriptBox[\(b\), \(^\)]\),\!\(\*OverscriptBox[\(a\), \(^\
\)]\),-\!\(\*OverscriptBox[\(c\), \(^\)]\)], it will create an infinite loop \
the next time Mathematica sees a product of the two operators.\>\""}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"AntiCommutator", "[", 
    RowBox[{"a_", ",", "b_", ",", "c_"}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"pa", "=", 
        RowBox[{"pattClean", "[", "a", "]"}]}], ",", 
       RowBox[{"pb", "=", 
        RowBox[{"pattClean", "[", "b", "]"}]}], ",", 
       RowBox[{"aa", "=", "a"}], ",", 
       RowBox[{"bb", "=", "b"}]}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"aa", ",", "bb"}], "]"}], ":=", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"op", "[", 
          RowBox[{"pb", ",", "pa"}], "]"}]}], "+", "c"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n1__", ",", "aa", ",", "bb"}], "]"}], ":=", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"op", "[", 
          RowBox[{"n1", ",", "pb", ",", "pa"}], "]"}]}], "+", 
        RowBox[{"op", "[", 
         RowBox[{"n1", ",", "c"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"aa", ",", "bb", ",", "m1__"}], "]"}], ":=", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"op", "[", 
          RowBox[{"pb", ",", "pa", ",", "m1"}], "]"}]}], "+", 
        RowBox[{"op", "[", 
         RowBox[{"c", ",", "m1"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n1__", ",", "aa", ",", "bb", ",", "m1__"}], "]"}], ":=", 
       RowBox[{
        RowBox[{"-", 
         RowBox[{"op", "[", 
          RowBox[{"n1", ",", "pb", ",", "pa", ",", "m1"}], "]"}]}], "+", 
        RowBox[{"op", "[", 
         RowBox[{"n1", ",", "c", ",", "m1"}], "]"}]}]}], ";"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CommutingList", "[", "a_", "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{"Commutator", "[", 
        RowBox[{
         RowBox[{"a", "[", 
          RowBox[{"[", "ii", "]"}], "]"}], ",", 
         RowBox[{"a", "[", 
          RowBox[{"[", "jj", "]"}], "]"}], ",", "0"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"ii", ",", "1", ",", 
         RowBox[{
          RowBox[{"Length", "[", "a", "]"}], "-", "1"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"jj", ",", 
         RowBox[{"ii", "+", "1"}], ",", 
         RowBox[{"Length", "[", "a", "]"}]}], "}"}]}], "]"}], ";"}], 
    "\[IndentingNewLine]", ")"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"AnticommutingList", "[", "a_", "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Do", "[", 
      RowBox[{
       RowBox[{"AntiCommutator", "[", 
        RowBox[{
         RowBox[{"a", "[", 
          RowBox[{"[", "ii", "]"}], "]"}], ",", 
         RowBox[{"a", "[", 
          RowBox[{"[", "jj", "]"}], "]"}], ",", "0"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"ii", ",", "1", ",", 
         RowBox[{
          RowBox[{"Length", "[", "a", "]"}], "-", "1"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"jj", ",", 
         RowBox[{"ii", "+", "1"}], ",", 
         RowBox[{"Length", "[", "a", "]"}]}], "}"}]}], "]"}], ";"}], 
    "\[IndentingNewLine]", ")"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"contraction", "[", 
    RowBox[{"a_", ",", "b_", ",", "c_"}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"pa", "=", 
        RowBox[{"pattClean", "[", "a", "]"}]}], ",", 
       RowBox[{"pb", "=", 
        RowBox[{"pattClean", "[", "b", "]"}]}], ",", 
       RowBox[{"aa", "=", "a"}], ",", 
       RowBox[{"bb", "=", "b"}]}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"aa", ",", "bb"}], "]"}], ":=", "c"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n1__", ",", "aa", ",", "bb"}], "]"}], ":=", 
       RowBox[{"op", "[", 
        RowBox[{"n1", ",", "c"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"aa", ",", "bb", ",", "m1__"}], "]"}], ":=", 
       RowBox[{"op", "[", 
        RowBox[{"c", ",", "m1"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n1__", ",", "aa", ",", "bb", ",", "m1__"}], "]"}], ":=", 
       RowBox[{"op", "[", 
        RowBox[{"n1", ",", "c", ",", "m1"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{
         RowBox[{"SuperDagger", "[", "bb", "]"}], ",", 
         RowBox[{"SuperDagger", "[", "aa", "]"}]}], "]"}], ":=", 
       RowBox[{"SuperDagger", "[", "c", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n1__", ",", 
         RowBox[{"SuperDagger", "[", "bb", "]"}], ",", 
         RowBox[{"SuperDagger", "[", "aa", "]"}]}], "]"}], ":=", 
       RowBox[{"op", "[", 
        RowBox[{"n1", ",", 
         RowBox[{"SuperDagger", "[", "c", "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{
         RowBox[{"SuperDagger", "[", "bb", "]"}], ",", 
         RowBox[{"SuperDagger", "[", "aa", "]"}], ",", "m1__"}], "]"}], ":=", 
       RowBox[{"op", "[", 
        RowBox[{
         RowBox[{"SuperDagger", "[", "c", "]"}], ",", "m1"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n1__", ",", 
         RowBox[{"SuperDagger", "[", "bb", "]"}], ",", 
         RowBox[{"SuperDagger", "[", "aa", "]"}], ",", "m1__"}], "]"}], ":=", 
       RowBox[{"op", "[", 
        RowBox[{"n1", ",", 
         RowBox[{"SuperDagger", "[", "c", "]"}], ",", "m1"}], "]"}]}], 
      ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"contractionUnidirectional", "[", 
    RowBox[{"a_", ",", "b_", ",", "c_"}], "]"}], ":=", 
   RowBox[{"With", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"pa", "=", 
        RowBox[{"pattClean", "[", "a", "]"}]}], ",", 
       RowBox[{"pb", "=", 
        RowBox[{"pattClean", "[", "b", "]"}]}], ",", 
       RowBox[{"aa", "=", "a"}], ",", 
       RowBox[{"bb", "=", "b"}]}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"aa", ",", "bb"}], "]"}], ":=", "c"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n1__", ",", "aa", ",", "bb"}], "]"}], ":=", 
       RowBox[{"op", "[", 
        RowBox[{"n1", ",", "c"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"aa", ",", "bb", ",", "m1__"}], "]"}], ":=", 
       RowBox[{"op", "[", 
        RowBox[{"c", ",", "m1"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n1__", ",", "aa", ",", "bb", ",", "m1__"}], "]"}], ":=", 
       RowBox[{"op", "[", 
        RowBox[{"n1", ",", "c", ",", "m1"}], "]"}]}], ";"}]}], 
    "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"selfCommutingField", "[", "\[Psi]_", "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n", ",", 
         SubscriptBox["\[Psi]", "b"], ",", 
         SubscriptBox["\[Psi]", "a"], ",", "m"}], "]"}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n", ",", 
         SubscriptBox["\[Psi]", "b"], ",", 
         SubscriptBox["\[Psi]", "a"]}], "]"}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{
         SubscriptBox["\[Psi]", "b"], ",", 
         SubscriptBox["\[Psi]", "a"], ",", "m"}], "]"}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{
         SubscriptBox["\[Psi]", "b"], ",", 
         SubscriptBox["\[Psi]", "a"]}], "]"}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n", ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "b"], "]"}], ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "a"], "]"}], ",", "m"}], "]"}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n", ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "b"], "]"}], ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "a"], "]"}]}], "]"}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "b"], "]"}], ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "a"], "]"}], ",", "m"}], "]"}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "b"], "]"}], ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "a"], "]"}]}], "]"}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";"}], 
    "\[IndentingNewLine]", ")"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"selfCommutingFieldOrderingOnIndexList", "[", 
    RowBox[{"\[Psi]_", ",", "indexList_"}], "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n", ",", 
         SubscriptBox["\[Psi]", "b"], ",", 
         SubscriptBox["\[Psi]", "a"], ",", "m"}], "]"}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n", ",", 
         SubscriptBox["\[Psi]", "b"], ",", 
         SubscriptBox["\[Psi]", "a"]}], "]"}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{
         SubscriptBox["\[Psi]", "b"], ",", 
         SubscriptBox["\[Psi]", "a"], ",", "m"}], "]"}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{
         SubscriptBox["\[Psi]", "b"], ",", 
         SubscriptBox["\[Psi]", "a"]}], "]"}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n", ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "b"], "]"}], ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "a"], "]"}], ",", "m"}], "]"}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{"n", ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "b"], "]"}], ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "a"], "]"}]}], "]"}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "b"], "]"}], ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "a"], "]"}], ",", "m"}], "]"}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"op", "[", 
        RowBox[{
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "b"], "]"}], ",", 
         RowBox[{"SuperDagger", "[", 
          SubscriptBox["\[Psi]", "a"], "]"}]}], "]"}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";"}], "\[IndentingNewLine]", ")"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"selfAnticommutingField", "[", "\[Psi]_", "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{"n", ",", 
          SubscriptBox["\[Psi]", "b"], ",", 
          SubscriptBox["\[Psi]", "a"], ",", "m"}], "]"}]}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{"n", ",", 
          SubscriptBox["\[Psi]", "b"], ",", 
          SubscriptBox["\[Psi]", "a"]}], "]"}]}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{
          SubscriptBox["\[Psi]", "b"], ",", 
          SubscriptBox["\[Psi]", "a"], ",", "m"}], "]"}]}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{
          SubscriptBox["\[Psi]", "b"], ",", 
          SubscriptBox["\[Psi]", "a"]}], "]"}]}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{"n", ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "b"], "]"}], ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "a"], "]"}], ",", "m"}], "]"}]}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{"n", ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "b"], "]"}], ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "a"], "]"}]}], "]"}]}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "b"], "]"}], ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "a"], "]"}], ",", "m"}], "]"}]}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "b"], "]"}], ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "a"], "]"}]}], "]"}]}], "/;", 
       RowBox[{"!", 
        RowBox[{"OrderedQ", "[", 
         RowBox[{"{", 
          RowBox[{"a", ",", "b"}], "}"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "a_"], ",", "m__"}], "]"}], ":=", "0"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "a_"]}], "]"}], ":=", "0"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "a_"], ",", "m__"}], "]"}], ":=", "0"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "a_"]}], "]"}], ":=", "0"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", "m__"}], "]"}], ":=", 
      "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}]}], "]"}], "=", "0"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", "m__"}], "]"}], "=", "0"}],
      ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}]}], "]"}], "=", "0"}], ";"}], 
    "\[IndentingNewLine]", ")"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"selfAnticommutingFieldOrderingOnIndexList", "[", 
    RowBox[{"\[Psi]_", ",", "indexList_"}], "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{"n", ",", 
          SubscriptBox["\[Psi]", "b"], ",", 
          SubscriptBox["\[Psi]", "a"], ",", "m"}], "]"}]}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{"n", ",", 
          SubscriptBox["\[Psi]", "b"], ",", 
          SubscriptBox["\[Psi]", "a"]}], "]"}]}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{
          SubscriptBox["\[Psi]", "b"], ",", 
          SubscriptBox["\[Psi]", "a"], ",", "m"}], "]"}]}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "b_"]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{
          SubscriptBox["\[Psi]", "b"], ",", 
          SubscriptBox["\[Psi]", "a"]}], "]"}]}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{"n", ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "b"], "]"}], ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "a"], "]"}], ",", "m"}], "]"}]}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{"n", ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "b"], "]"}], ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "a"], "]"}]}], "]"}]}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}], ",", "m__"}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "b"], "]"}], ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "a"], "]"}], ",", "m"}], "]"}]}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "b_"], "]"}]}], "]"}], ":=", 
      RowBox[{
       RowBox[{"-", 
        RowBox[{"op", "[", 
         RowBox[{
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "b"], "]"}], ",", 
          RowBox[{"SuperDagger", "[", 
           SubscriptBox["\[Psi]", "a"], "]"}]}], "]"}]}], "/;", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}], "\[Equal]", 
          RowBox[{"b", "[", 
           RowBox[{"[", "indexList", "]"}], "]"}]}]}], "&&", 
        RowBox[{"!", 
         RowBox[{"Apply", "[", 
          RowBox[{"Or", ",", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{"OrderedQ", "[", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"a", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}], ",", 
                RowBox[{"b", "[", 
                 RowBox[{"[", 
                  RowBox[{"indexList", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], "]"}], "]"}]}], "}"}], 
              "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", 
               RowBox[{"Length", "[", "indexList", "]"}]}], "}"}]}], "]"}]}], 
          "]"}]}]}]}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "a_"], ",", "m__"}], "]"}], ":=", "0"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "a_"]}], "]"}], ":=", "0"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "a_"], ",", "m__"}], "]"}], ":=", "0"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        SubscriptBox["\[Psi]", "a_"], ",", 
        SubscriptBox["\[Psi]", "a_"]}], "]"}], ":=", "0"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", "m__"}], "]"}], ":=", 
      "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n__", ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}]}], "]"}], "=", "0"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", "m__"}], "]"}], "=", "0"}],
      ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}], ",", 
        RowBox[{"SuperDagger", "[", 
         SubscriptBox["\[Psi]", "a_"], "]"}]}], "]"}], "=", "0"}], ";"}], 
    "\[IndentingNewLine]", ")"}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ifin", "[", 
   RowBox[{"a_", ",", "list_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"j", ",", 
      RowBox[{"l", "=", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Head", "[", "list", "]"}], "==", "List"}], ",", "list", 
         ",", 
         RowBox[{"{", "list", "}"}]}], "]"}]}]}], "}"}], ",", 
    RowBox[{"Or", "@@", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"a", "==", 
        RowBox[{"l", "[", 
         RowBox[{"[", "j", "]"}], "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "1", ",", 
         RowBox[{"Length", "[", "l", "]"}]}], "}"}]}], "]"}]}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"iffreeq", "[", 
    RowBox[{"a__", ",", "list_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"j", ",", 
       RowBox[{"l", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Head", "[", "list", "]"}], "==", "List"}], ",", "list", 
          ",", 
          RowBox[{"{", "list", "}"}]}], "]"}]}]}], "}"}], ",", 
     RowBox[{"And", "@@", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"FreeQ", "[", 
         RowBox[{
          RowBox[{"{", "a", "}"}], ",", 
          RowBox[{"l", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "l", "]"}]}], "}"}]}], "]"}]}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"expect", "[", 
    RowBox[{"expr_", ",", "\[Rho]_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "oip", "}"}], " ", ",", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{"expr", "/.", 
          RowBox[{"op", "->", "oip"}]}], ")"}], "//.", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"oip", "[", 
            RowBox[{"n__", ",", "\[Rho]", ",", "m__"}], "]"}], ":>", 
           RowBox[{"oip", "[", 
            RowBox[{"m", ",", "n", ",", "\[Rho]"}], "]"}]}], ",", 
          RowBox[{
           RowBox[{"oip", "[", 
            RowBox[{"\[Rho]", ",", "m__"}], "]"}], ":>", 
           RowBox[{"oip", "[", 
            RowBox[{"m", ",", "\[Rho]"}], "]"}]}]}], "}"}]}], ")"}], "/.", 
      RowBox[{"{", 
       RowBox[{"oip", "->", "op"}], "}"}]}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"expect", "[", 
    RowBox[{"a_", ",", "expr_", ",", "\[Rho]_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"oip", ",", "iffreeqLocal", ",", "repListLocal"}], "}"}], " ", 
     ",", 
     RowBox[{"With", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"ppa", "=", 
          RowBox[{"pattClean", "[", 
           RowBox[{"Flatten", "[", 
            RowBox[{"{", "a", "}"}], "]"}], "]"}]}], ",", 
         RowBox[{"aaa", "=", 
          RowBox[{"Flatten", "[", 
           RowBox[{"{", "a", "}"}], "]"}]}]}], "}"}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"iffreeqLocal", "[", "list_", "]"}], ":=", 
         RowBox[{"iffreeq", "[", 
          RowBox[{"list", ",", "aaa"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"repListLocal", "=", 
         RowBox[{"Flatten", "[", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"With", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"j", "=", "j0"}], ",", 
                RowBox[{"pa", "=", 
                 RowBox[{"ppa", "[", 
                  RowBox[{"[", "j0", "]"}], "]"}]}], ",", 
                RowBox[{"aa", "=", "aaa"}]}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"n__", ",", "\[Rho]", ",", "m__", ",", 
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "n", ",", "\[Rho]", ",", "m"}], "]"}]}], 
                ",", 
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"\[Rho]", ",", "m__", ",", 
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "\[Rho]", ",", "m"}], "]"}]}], ",", 
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"n__", ",", "\[Rho]", ",", 
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "n", ",", "\[Rho]"}], "]"}]}], ",", 
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"\[Rho]", ",", 
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "\[Rho]"}], "]"}]}], " ", ",", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"oip", "[", 
                   RowBox[{"n__", ",", "\[Rho]", ",", "m__", ",", 
                    RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "l__"}], "]"}], "/;", 
                  RowBox[{"iffreeqLocal", "[", 
                   RowBox[{"{", "l", "}"}], "]"}]}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "n", ",", "\[Rho]", ",", "m", ",", "l"}],
                   "]"}]}], ",", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"oip", "[", 
                   RowBox[{"n__", ",", "\[Rho]", ",", 
                    RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "l__"}], "]"}], "/;", 
                  RowBox[{"iffreeqLocal", "[", 
                   RowBox[{"{", "l", "}"}], "]"}]}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "n", ",", "\[Rho]", ",", "l"}], "]"}]}], 
                ",", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"oip", "[", 
                   RowBox[{"\[Rho]", ",", "m__", ",", 
                    RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "l__"}], "]"}], "/;", 
                  RowBox[{"iffreeqLocal", "[", 
                   RowBox[{"{", "l", "}"}], "]"}]}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "\[Rho]", ",", "m", ",", "l"}], "]"}]}], 
                ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"oip", "[", 
                   RowBox[{"\[Rho]", ",", 
                    RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "l__"}], "]"}], "/;", 
                  RowBox[{"iffreeqLocal", "[", 
                   RowBox[{"{", "l", "}"}], "]"}]}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "\[Rho]", ",", "l"}], "]"}]}]}], "}"}]}],
              "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"j0", ",", "1", ",", 
              RowBox[{"Length", "[", "ppa", "]"}]}], "}"}]}], "]"}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"expr", "/.", 
             RowBox[{"op", "->", "oip"}]}], ")"}], "//.", " ", 
           "repListLocal"}], ")"}], "/.", 
         RowBox[{"{", 
          RowBox[{"oip", "->", "op"}], "}"}]}]}]}], "]"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"expect", "[", 
    RowBox[{"a_", ",", "expr_", ",", "\[Rho]_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"oip", ",", "iffreeqLocal", ",", "repListLocal"}], "}"}], " ", 
     ",", 
     RowBox[{"With", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"ppa", "=", 
          RowBox[{"pattClean", "[", 
           RowBox[{"Flatten", "[", 
            RowBox[{"{", "a", "}"}], "]"}], "]"}]}], ",", 
         RowBox[{"aaa", "=", 
          RowBox[{"Flatten", "[", 
           RowBox[{"{", "a", "}"}], "]"}]}]}], "}"}], ",", 
       RowBox[{
        RowBox[{
         RowBox[{"iffreeqLocal", "[", "list_", "]"}], ":=", 
         RowBox[{"iffreeq", "[", 
          RowBox[{"list", ",", "aaa"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"repListLocal", "=", 
         RowBox[{"Flatten", "[", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"With", "[", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"j", "=", "j0"}], ",", 
                RowBox[{"pa", "=", 
                 RowBox[{"ppa", "[", 
                  RowBox[{"[", "j0", "]"}], "]"}]}], ",", 
                RowBox[{"aa", "=", "aaa"}]}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"n__", ",", "\[Rho]", ",", "m__", ",", 
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "n", ",", "\[Rho]", ",", "m"}], "]"}]}], 
                ",", 
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"\[Rho]", ",", "m__", ",", 
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "\[Rho]", ",", "m"}], "]"}]}], ",", 
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"n__", ",", "\[Rho]", ",", 
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "n", ",", "\[Rho]"}], "]"}]}], ",", 
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"\[Rho]", ",", 
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], "]"}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "\[Rho]"}], "]"}]}], " ", ",", 
                "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"oip", "[", 
                   RowBox[{"n__", ",", "\[Rho]", ",", "m__", ",", 
                    RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "l__"}], "]"}], "/;", 
                  RowBox[{"iffreeqLocal", "[", 
                   RowBox[{"{", "l", "}"}], "]"}]}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "n", ",", "\[Rho]", ",", "m", ",", "l"}],
                   "]"}]}], ",", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"oip", "[", 
                   RowBox[{"n__", ",", "\[Rho]", ",", 
                    RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "l__"}], "]"}], "/;", 
                  RowBox[{"iffreeqLocal", "[", 
                   RowBox[{"{", "l", "}"}], "]"}]}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "n", ",", "\[Rho]", ",", "l"}], "]"}]}], 
                ",", "\[IndentingNewLine]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"oip", "[", 
                   RowBox[{"\[Rho]", ",", "m__", ",", 
                    RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "l__"}], "]"}], "/;", 
                  RowBox[{"iffreeqLocal", "[", 
                   RowBox[{"{", "l", "}"}], "]"}]}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "\[Rho]", ",", "m", ",", "l"}], "]"}]}], 
                ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"oip", "[", 
                   RowBox[{"\[Rho]", ",", 
                    RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "l__"}], "]"}], "/;", 
                  RowBox[{"iffreeqLocal", "[", 
                   RowBox[{"{", "l", "}"}], "]"}]}], "\[RuleDelayed]", 
                 RowBox[{"oip", "[", 
                  RowBox[{"pa", ",", "\[Rho]", ",", "l"}], "]"}]}]}], "}"}]}],
              "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"j0", ",", "1", ",", 
              RowBox[{"Length", "[", "ppa", "]"}]}], "}"}]}], "]"}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"expr", "/.", 
             RowBox[{"op", "->", "oip"}]}], ")"}], "//.", " ", 
           "repListLocal"}], ")"}], "/.", 
         RowBox[{"{", 
          RowBox[{"oip", "->", "op"}], "}"}]}]}]}], "]"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"vacExpect", "[", 
   RowBox[{"a_", ",", "expr_", ",", "\[Rho]_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "oip", ",", "iffreeqLocala", ",", "iffreeqLocalaDagger", ",", 
      "repListLocal"}], "}"}], " ", ",", "\[IndentingNewLine]", 
    RowBox[{"With", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"ppa", "=", 
         RowBox[{"pattClean", "[", 
          RowBox[{"Flatten", "[", 
           RowBox[{"{", "a", "}"}], "]"}], "]"}]}], ",", 
        RowBox[{"aaa", "=", 
         RowBox[{"Flatten", "[", 
          RowBox[{"{", "a", "}"}], "]"}]}]}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"iffreeqLocala", "[", "list_", "]"}], ":=", 
        RowBox[{"iffreeq", "[", 
         RowBox[{"list", ",", "aaa"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"iffreeqLocalaDagger", "[", "list_", "]"}], ":=", 
        RowBox[{"iffreeq", "[", 
         RowBox[{"list", ",", 
          RowBox[{"SuperDagger", "[", "aaa", "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"repListLocal", "=", 
        RowBox[{"Flatten", "[", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"j", "=", "j0"}], ",", 
               RowBox[{"aa", "=", "aaa"}]}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"n__", ",", 
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "m__", ",", "\[Rho]",
                    ",", "l__"}], "]"}], "/;", 
                 RowBox[{"iffreeqLocalaDagger", "[", 
                  RowBox[{"{", "m", "}"}], "]"}]}], "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"n__", ",", 
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "m__", ",", 
                   "\[Rho]"}], "]"}], "/;", 
                 RowBox[{"iffreeqLocalaDagger", "[", 
                  RowBox[{"{", "m", "}"}], "]"}]}], "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{"oip", "[", 
                 RowBox[{"n__", ",", 
                  RowBox[{"aa", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], ",", "\[Rho]", ",", 
                  "l__"}], "]"}], "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "m__", ",", "\[Rho]",
                    ",", "l__"}], "]"}], "/;", 
                 RowBox[{"iffreeqLocalaDagger", "[", 
                  RowBox[{"{", "m", "}"}], "]"}]}], "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{
                   RowBox[{"aa", "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "m__", ",", 
                   "\[Rho]"}], "]"}], "/;", 
                 RowBox[{"iffreeqLocalaDagger", "[", 
                  RowBox[{"{", "m", "}"}], "]"}]}], "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{"oip", "[", 
                 RowBox[{
                  RowBox[{"aa", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], ",", "\[Rho]", ",", 
                  "l__"}], "]"}], "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{"oip", "[", 
                 RowBox[{"n__", ",", 
                  RowBox[{"a", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], ",", "\[Rho]"}], "]"}], 
                "\[Rule]", "0"}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"oip", "[", 
                 RowBox[{
                  RowBox[{"a", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], ",", "\[Rho]"}], "]"}], 
                "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"n__", ",", 
                   RowBox[{
                    RowBox[{"SuperDagger", "[", "aa", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "m__", ",", "\[Rho]",
                    ",", "l__"}], "]"}], "/;", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"iffreeqLocala", "[", 
                    RowBox[{"{", "n", "}"}], "]"}], "&&", 
                   RowBox[{"iffreeqLocala", "[", 
                    RowBox[{"{", "l", "}"}], "]"}]}], ")"}]}], "\[Rule]", 
                "0"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"n__", ",", 
                   RowBox[{
                    RowBox[{"SuperDagger", "[", "aa", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "m__", ",", 
                   "\[Rho]"}], "]"}], "/;", 
                 RowBox[{"iffreeqLocala", "[", 
                  RowBox[{"{", "n", "}"}], "]"}]}], "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"n__", ",", 
                   RowBox[{
                    RowBox[{"SuperDagger", "[", "aa", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "\[Rho]", ",", 
                   "l__"}], "]"}], "/;", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"iffreeqLocala", "[", 
                    RowBox[{"{", "n", "}"}], "]"}], "&&", 
                   RowBox[{"iffreeqLocala", "[", 
                    RowBox[{"{", "l", "}"}], "]"}]}], ")"}]}], "\[Rule]", 
                "0"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"SuperDagger", "[", "aa", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "m__", ",", "\[Rho]",
                    ",", "l__"}], "]"}], "/;", 
                 RowBox[{"iffreeqLocala", "[", 
                  RowBox[{"{", "l", "}"}], "]"}]}], "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{"oip", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"SuperDagger", "[", "aa", "]"}], "[", 
                   RowBox[{"[", "j", "]"}], "]"}], ",", "m__", ",", 
                  "\[Rho]"}], "]"}], "\[Rule]", "0"}], ",", 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"oip", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"SuperDagger", "[", "aa", "]"}], "[", 
                   RowBox[{"[", "j", "]"}], "]"}], ",", "\[Rho]"}], "]"}], 
                "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"SuperDagger", "[", "aa", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "\[Rho]", ",", 
                   "l__"}], "]"}], "/;", 
                 RowBox[{"iffreeqLocala", "[", 
                  RowBox[{"{", "l", "}"}], "]"}]}], "\[Rule]", "0"}], ",", 
               RowBox[{
                RowBox[{
                 RowBox[{"oip", "[", 
                  RowBox[{"n__", ",", 
                   RowBox[{
                    RowBox[{"SuperDagger", "[", "aa", "]"}], "[", 
                    RowBox[{"[", "j", "]"}], "]"}], ",", "\[Rho]"}], "]"}], "/;", 
                 RowBox[{"iffreeqLocala", "[", 
                  RowBox[{"{", "n", "}"}], "]"}]}], "\[Rule]", "0"}]}], 
              "}"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"j0", ",", "1", ",", 
             RowBox[{"Length", "[", "a", "]"}]}], "}"}]}], "]"}], "]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"Simplify", "[", 
          RowBox[{
           RowBox[{"expect", "[", 
            RowBox[{
             RowBox[{"Union", "[", 
              RowBox[{"aaa", ",", 
               RowBox[{"SuperDagger", "[", "aaa", "]"}]}], "]"}], ",", "expr",
              ",", "\[Rho]"}], "]"}], "/.", "\[InvisibleSpace]", 
           RowBox[{"{", 
            RowBox[{"op", "\[Rule]", "oip"}], "}"}]}], "]"}], "//.", 
         "\[InvisibleSpace]", "repListLocal"}], "/.", "\[InvisibleSpace]", 
        RowBox[{"{", 
         RowBox[{"oip", "\[Rule]", "op"}], "}"}]}]}]}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[ScriptCapitalD]", "[", 
   RowBox[{"c_", ",", "\[Rho]_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{"c", ",", "\[Rho]", ",", 
     RowBox[{"SuperDagger", "[", "c", "]"}]}], "]"}], "-", 
   RowBox[{
    FractionBox["1", "2"], 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", "c", "]"}], ",", "c", ",", "\[Rho]"}], 
       "]"}], "+", 
      RowBox[{"op", "[", 
       RowBox[{"\[Rho]", ",", 
        RowBox[{"SuperDagger", "[", "c", "]"}], ",", "c"}], "]"}]}], 
     ")"}]}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[ScriptCapitalD]s", "[", 
   RowBox[{"c_", ",", "\[Rho]_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"op", "[", 
    RowBox[{
     RowBox[{"SuperDagger", "[", "c", "]"}], ",", "\[Rho]", ",", "c"}], "]"}],
    "-", 
   RowBox[{
    FractionBox["1", "2"], 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{
        RowBox[{"SuperDagger", "[", "c", "]"}], ",", "c", ",", "\[Rho]"}], 
       "]"}], "+", 
      RowBox[{"op", "[", 
       RowBox[{"\[Rho]", ",", 
        RowBox[{"SuperDagger", "[", "c", "]"}], ",", "c"}], "]"}]}], 
     ")"}]}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"symmetriser", "[", "l_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"a", ",", "b"}], "}"}], ",", 
     RowBox[{
      RowBox[{"a", "=", 
       RowBox[{"Permutations", "[", "l", "]"}]}], ";", 
      RowBox[{"b", "=", 
       RowBox[{"Length", "[", "a", "]"}]}], ";", 
      RowBox[{
       RowBox[{"Total", "[", 
        RowBox[{"Apply", "[", 
         RowBox[{"op", ",", "a", ",", "1"}], "]"}], "]"}], "/", "b"}]}]}], 
    "]"}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"dummyCanonical", "[", 
    RowBox[{"dummyList_", ",", "expr_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "oip", ",", "dv", ",", "dv2", ",", "dv3", ",", "opPart", ",", "varList",
        ",", "swapList", ",", "term", ",", "l", ",", "output"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"l", "=", 
       RowBox[{"Expand", "[", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"1", "+", "expr"}], ")"}], "/.", 
         RowBox[{"op", "\[Rule]", "oip"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"swapList", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"dummyList", "[", 
           RowBox[{"[", "jj", "]"}], "]"}], "\[Rule]", 
          RowBox[{"dv", "[", "jj", "]"}]}], ",", 
         RowBox[{"{", 
          RowBox[{"jj", ",", "1", ",", 
           RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], "]"}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{"l", "=", 
       RowBox[{"(", 
        RowBox[{"l", "/.", "swapList"}], ")"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"output", "=", 
       RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"term", "=", 
          RowBox[{"l", "[", 
           RowBox[{"[", "j", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
         "    ", 
         RowBox[{"dv3", "=", 
          RowBox[{"Position", "[", 
           RowBox[{"term", ",", "oip"}], "]"}]}], ";", "\[IndentingNewLine]", 
         "    ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "dv3", "]"}], ">", "0"}], ",", 
           "\[IndentingNewLine]", "    ", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"dv3", "[", 
                RowBox[{"[", 
                 RowBox[{"1", ",", "1"}], "]"}], "]"}], "\[Equal]", "0"}], 
              ",", 
              RowBox[{"opPart", "=", "term"}], ",", 
              RowBox[{"opPart", "=", 
               RowBox[{"term", "[", 
                RowBox[{"[", 
                 RowBox[{"dv3", "[", 
                  RowBox[{"[", 
                   RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}], "]"}]}]}], 
             "]"}], ";", "\[IndentingNewLine]", "    ", 
            RowBox[{"varList", "=", 
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"dv2", "=", 
                 RowBox[{"Position", "[", 
                  RowBox[{"opPart", ",", 
                   RowBox[{"dv", "[", "k", "]"}]}], "]"}]}], ";", 
                "\[IndentingNewLine]", 
                "                                       ", 
                RowBox[{"If", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Length", "[", "dv2", "]"}], ">", "0"}], ",", 
                  RowBox[{"dv2", "[", 
                   RowBox[{"[", 
                    RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", "0"}], 
                 "]"}]}], "\[IndentingNewLine]", "                          ",
                ",", 
               RowBox[{"{", 
                RowBox[{"k", ",", "1", ",", 
                 RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], 
              "]"}]}], ";", "\[IndentingNewLine]", "    ", 
            RowBox[{"swapList", "=", 
             RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", "     ", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"Length", "[", "varList", "]"}], ">", "0"}], "&&", 
               RowBox[{
                RowBox[{"Max", "[", "varList", "]"}], ">", "0"}]}], ",", 
              "\[IndentingNewLine]", "                        ", 
              RowBox[{
               RowBox[{"Do", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"dv3", "=", 
                   RowBox[{"Position", "[", 
                    RowBox[{"varList", ",", "n"}], "]"}]}], ";", 
                  "\[IndentingNewLine]", "                             ", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"Length", "[", "dv3", "]"}], ">", "0"}], ",", 
                    RowBox[{"swapList", "=", 
                    RowBox[{"Append", "[", 
                    RowBox[{"swapList", ",", 
                    RowBox[{"dv3", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1"}], "]"}], "]"}]}], "]"}]}], ",", 
                    "0"}], "]"}], ";"}], "\[IndentingNewLine]", 
                 "                      ", ",", 
                 RowBox[{"{", 
                  RowBox[{"n", ",", "1", ",", 
                   RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], 
                "]"}], ";", "\[IndentingNewLine]", "                        ", 
               RowBox[{"varList", "=", 
                RowBox[{"Table", "[", 
                 RowBox[{"k", ",", 
                  RowBox[{"{", 
                   RowBox[{"k", ",", "1", ",", 
                    RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], 
                 "]"}]}], ";", "\[IndentingNewLine]", 
               "                        ", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Length", "[", "swapList", "]"}], "\[Equal]", 
                  RowBox[{"Length", "[", "dummyList", "]"}]}], ",", 
                 "\[IndentingNewLine]", "                                ", 
                 RowBox[{
                  RowBox[{"Do", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"varList", "[", 
                    RowBox[{"[", 
                    RowBox[{"swapList", "[", 
                    RowBox[{"[", "m", "]"}], "]"}], "]"}], "]"}], "=", 
                    RowBox[{"dummyList", "[", 
                    RowBox[{"[", "m", "]"}], "]"}]}], ",", 
                    RowBox[{"{", 
                    RowBox[{"m", ",", "1", ",", 
                    RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], 
                   "]"}], ";"}], ",", "\[IndentingNewLine]", 
                 "                          ", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"Do", "[", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"swapList", "[", 
                    RowBox[{"[", "k", "]"}], "]"}], "\[Equal]", 
                    RowBox[{"varList", "[", 
                    RowBox[{"[", "k", "]"}], "]"}]}], ",", "0", ",", 
                    RowBox[{
                    RowBox[{"varList", "=", 
                    RowBox[{"Permute", "[", 
                    RowBox[{"varList", ",", 
                    RowBox[{"Cycles", "[", 
                    RowBox[{"{", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Position", "[", 
                    RowBox[{"varList", ",", 
                    RowBox[{"swapList", "[", 
                    RowBox[{"[", "k", "]"}], "]"}]}], "]"}], "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", "k"}], "}"}], 
                    "}"}], "]"}]}], "]"}]}], ";"}]}], "]"}], 
                    "\[IndentingNewLine]", "                        ", ",", 
                    RowBox[{"{", 
                    RowBox[{"k", ",", "1", ",", 
                    RowBox[{"Length", "[", "swapList", "]"}]}], "}"}]}], 
                    "]"}], ";"}], 
                  RowBox[{"(*", " ", 
                   RowBox[{
                   "Full", " ", "swaplist", " ", "is", " ", "stored", " ", 
                    "in", " ", "varlist"}], " ", "*)"}], ";", 
                  "\[IndentingNewLine]", "                          ", 
                  RowBox[{"swapList", "=", 
                   RowBox[{"Table", "[", 
                    RowBox[{"k", ",", 
                    RowBox[{"{", 
                    RowBox[{"k", ",", "1", ",", 
                    RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  "                          ", 
                  RowBox[{"Do", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"swapList", "[", 
                    RowBox[{"[", 
                    RowBox[{"varList", "[", 
                    RowBox[{"[", "m", "]"}], "]"}], "]"}], "]"}], "=", 
                    RowBox[{"dummyList", "[", 
                    RowBox[{"[", "m", "]"}], "]"}]}], ",", 
                    RowBox[{"{", 
                    RowBox[{"m", ",", "1", ",", 
                    RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], 
                   "]"}], ";", "\[IndentingNewLine]", 
                  "                          ", 
                  RowBox[{"varList", "=", "swapList"}], ";"}]}], 
                "\[IndentingNewLine]", "                       ", "]"}]}], 
              "\[IndentingNewLine]", "              ", ",", 
              RowBox[{
               RowBox[{"varList", "=", "dummyList"}], ";"}]}], "]"}], ";", 
            "          ", "\[IndentingNewLine]", "    ", 
            RowBox[{"output", "=", 
             RowBox[{"Append", "[", 
              RowBox[{"output", ",", 
               RowBox[{"term", "/.", 
                RowBox[{"Table", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"dv", "[", "jj", "]"}], "\[Rule]", 
                   RowBox[{"varList", "[", 
                    RowBox[{"[", "jj", "]"}], "]"}]}], ",", 
                  RowBox[{"{", 
                   RowBox[{"jj", ",", "1", ",", 
                    RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], 
                 "]"}]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", " ", ",", 
           RowBox[{
            RowBox[{"dv3", "=", 
             RowBox[{"Position", "[", 
              RowBox[{"term", ",", "Operator"}], "]"}]}], ";", " ", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{"No", " ", "product", " ", "of", " ", "operators"}], 
              ",", " ", 
              RowBox[{
              "so", " ", "look", " ", "for", " ", "lone", " ", "operator"}]}],
              " ", "*)"}], "\[IndentingNewLine]", " ", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "[", "dv3", "]"}], ">", "0"}], ",", 
              RowBox[{"(*", " ", 
               RowBox[{"Lone", " ", "Operator"}], " ", "*)"}], " ", 
              "\[IndentingNewLine]", "                           ", 
              RowBox[{
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"dv3", "[", 
                   RowBox[{"[", 
                    RowBox[{"1", ",", "1"}], "]"}], "]"}], "\[Equal]", "0"}], 
                 ",", 
                 RowBox[{"opPart", "=", "term"}], ",", " ", 
                 RowBox[{"opPart", "=", 
                  RowBox[{"term", "[", 
                   RowBox[{"[", 
                    RowBox[{"dv3", "[", 
                    RowBox[{"[", 
                    RowBox[{"1", ",", "1"}], "]"}], "]"}], "]"}], "]"}]}]}], 
                "]"}], ";", "\[IndentingNewLine]", "\t\t         ", 
               RowBox[{"varList", "=", "dummyList"}], ";", 
               "\[IndentingNewLine]", "                           ", 
               RowBox[{"Do", "[", 
                RowBox[{
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{"MemberQ", "[", 
                    RowBox[{"opPart", ",", 
                    RowBox[{"dv", "[", "k", "]"}]}], "]"}], ",", 
                   RowBox[{"varList", "=", 
                    RowBox[{"Permute", "[", 
                    RowBox[{"dummyList", ",", 
                    RowBox[{"Cycles", "[", 
                    RowBox[{"{", 
                    RowBox[{"{", 
                    RowBox[{"1", ",", "k"}], "}"}], "}"}], "]"}]}], "]"}]}], 
                   ",", "0"}], "]"}], "\[IndentingNewLine]", 
                 "                                           ", ",", 
                 RowBox[{"{", 
                  RowBox[{"k", ",", "1", ",", 
                   RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], 
                "]"}], ";", "\[IndentingNewLine]", "        ", 
               RowBox[{"output", "=", 
                RowBox[{"Append", "[", 
                 RowBox[{"output", ",", 
                  RowBox[{"term", "/.", 
                   RowBox[{"Table", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"dv", "[", "jj", "]"}], "\[Rule]", 
                    RowBox[{"varList", "[", 
                    RowBox[{"[", "jj", "]"}], "]"}]}], ",", 
                    RowBox[{"{", 
                    RowBox[{"jj", ",", "1", ",", 
                    RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], 
                    "]"}]}]}], "]"}]}], ";"}], "   ", "\[IndentingNewLine]", 
              " ", ",", 
              RowBox[{"output", "=", 
               RowBox[{"Append", "[", 
                RowBox[{"output", ",", 
                 RowBox[{"term", "/.", 
                  RowBox[{"Table", "[", 
                   RowBox[{
                    RowBox[{
                    RowBox[{"dv", "[", "jj", "]"}], "\[Rule]", 
                    RowBox[{"dummyList", "[", 
                    RowBox[{"[", "jj", "]"}], "]"}]}], ",", 
                    RowBox[{"{", 
                    RowBox[{"jj", ",", "1", ",", 
                    RowBox[{"Length", "[", "dummyList", "]"}]}], "}"}]}], 
                   "]"}]}]}], "]"}]}]}], " ", 
             RowBox[{"(*", " ", 
              RowBox[{
               RowBox[{"No", " ", "operators"}], ",", " ", 
               RowBox[{"nothing", " ", "to", " ", 
                RowBox[{"do", "."}]}]}], " ", "*)"}], "]"}]}]}], "]"}]}], 
        "\[IndentingNewLine]", ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "[", "l", "]"}]}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Apply", "[", 
           RowBox[{
            RowBox[{"Head", "[", "l", "]"}], ",", "output"}], "]"}], "-", 
          "1"}], ")"}], "/.", 
        RowBox[{"oip", "\[Rule]", "op"}]}], ")"}]}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"stochOpReplacement", "[", 
    RowBox[{"a_", ",", "left_", ",", "right_", ",", "\[Rho]_"}], "]"}], ":=", 
   RowBox[{"(", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"a", ",", "\[Rho]"}], "]"}], ":=", 
      RowBox[{"op", "[", 
       RowBox[{"left", ",", "\[Rho]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n1__", ",", "a", ",", "\[Rho]"}], "]"}], ":=", 
      RowBox[{"op", "[", 
       RowBox[{"left", ",", "n1", ",", "\[Rho]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"a", ",", "\[Rho]", ",", "m1__"}], "]"}], ":=", 
      RowBox[{"op", "[", 
       RowBox[{"left", ",", "\[Rho]", ",", "m1"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n1__", ",", "a", ",", "\[Rho]", ",", "m1__"}], "]"}], ":=", 
      RowBox[{"op", "[", 
       RowBox[{"left", ",", "n1", ",", "\[Rho]", ",", "m1"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"\[Rho]", ",", "a"}], "]"}], ":=", 
      RowBox[{"op", "[", 
       RowBox[{"right", ",", "\[Rho]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n1__", ",", "\[Rho]", ",", "a"}], "]"}], ":=", 
      RowBox[{"op", "[", 
       RowBox[{"right", ",", "n1", ",", "\[Rho]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"\[Rho]", ",", "a", ",", "m1__"}], "]"}], ":=", 
      RowBox[{"op", "[", 
       RowBox[{"right", ",", "\[Rho]", ",", "m1"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"op", "[", 
       RowBox[{"n1__", ",", "\[Rho]", ",", "a", ",", "m1__"}], "]"}], ":=", 
      RowBox[{"op", "[", 
       RowBox[{"right", ",", "n1", ",", "\[Rho]", ",", "m1"}], "]"}]}], ";"}],
     "\[IndentingNewLine]", ")"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"leviCivitaTensor", "[", 
   RowBox[{"i_", ",", "j_", ",", "k_"}], "]"}], ":=", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"i", "\[NotEqual]", "j", "\[NotEqual]", "k"}], ",", 
    SuperscriptBox[
     RowBox[{"(", 
      RowBox[{"-", "1"}], ")"}], 
     RowBox[{
      RowBox[{"PermutationOrder", "[", 
       RowBox[{"{", 
        RowBox[{"i", ",", "j", ",", "k"}], "}"}], "]"}], "+", "1"}]], ",", 
    "0"}], "]"}]}]}], "Input",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 InitializationGroup->True,
 CellChangeTimes->{{3.5206440236854343`*^9, 3.520644025914178*^9}, {
   3.520644095536879*^9, 3.52064412789257*^9}, {3.520644260223447*^9, 
   3.5206443042266827`*^9}, {3.520644401800246*^9, 3.520644414436377*^9}, {
   3.520644990190806*^9, 3.520645019635195*^9}, {3.52064510269578*^9, 
   3.520645104911418*^9}, {3.520645273718806*^9, 3.52064527410568*^9}, {
   3.520652126727886*^9, 3.520652127444428*^9}, 3.520652226032051*^9, {
   3.520652505463872*^9, 3.520652506085423*^9}, {3.520652764494809*^9, 
   3.520652878903697*^9}, {3.520652937186969*^9, 3.520652994448627*^9}, {
   3.520653070357457*^9, 3.520653077884132*^9}, 3.520653132240027*^9, 
   3.520653192812212*^9, {3.520653247411331*^9, 3.520653258582384*^9}, 
   3.5206540311267233`*^9, {3.520654382327483*^9, 3.520654432839287*^9}, 
   3.520654504956474*^9, {3.52065990814263*^9, 3.52065993979205*^9}, 
   3.5206604519817057`*^9, {3.52066050709435*^9, 3.520660561082993*^9}, {
   3.520661072672775*^9, 3.52066115636074*^9}, 3.520661404450118*^9, {
   3.520661451908085*^9, 3.520661472427223*^9}, 3.5206617642308693`*^9, {
   3.520661945587003*^9, 3.520661954954521*^9}, {3.520662184078578*^9, 
   3.520662281417235*^9}, 3.520662317150188*^9, {3.520662378411463*^9, 
   3.5206623829861097`*^9}, {3.520662418195554*^9, 3.520662453089287*^9}, {
   3.520662489633687*^9, 3.5206625354734983`*^9}, {3.520662583254645*^9, 
   3.520662584381857*^9}, {3.520662636796313*^9, 3.520662656038164*^9}, {
   3.520662710067913*^9, 3.520662728922359*^9}, {3.520707048824703*^9, 
   3.520707069976205*^9}, 3.520708931923586*^9, {3.520710731651483*^9, 
   3.520710793462136*^9}, {3.520710832344136*^9, 3.520710834364628*^9}, {
   3.520710878116153*^9, 3.5207108933942003`*^9}, 3.520710976362812*^9, {
   3.52071118058932*^9, 3.520711181675584*^9}, {3.520711312578012*^9, 
   3.520711326796606*^9}, {3.520716282947194*^9, 3.520716317269592*^9}, {
   3.520721513929694*^9, 3.520721549573285*^9}, {3.520726023429936*^9, 
   3.520726038781585*^9}, {3.520726240925037*^9, 3.520726343415975*^9}, {
   3.520726420455482*^9, 3.520726531691358*^9}, {3.52072938366877*^9, 
   3.520729385789607*^9}, {3.520740592818872*^9, 3.520740597922623*^9}, 
   3.520799936605442*^9, {3.520893975595438*^9, 3.520894025469073*^9}, {
   3.520894148207202*^9, 3.52089414878791*^9}, {3.52089456502481*^9, 
   3.520894568898263*^9}, {3.521021998479961*^9, 3.521022005674417*^9}, {
   3.521022681969984*^9, 3.521022691670992*^9}, {3.521023137250792*^9, 
   3.521023142865733*^9}, {3.5210243335129232`*^9, 3.521024343390506*^9}, 
   3.521024588226451*^9, {3.521025318969033*^9, 3.521025321158795*^9}, {
   3.521025403682993*^9, 3.52102555278532*^9}, {3.521025587878086*^9, 
   3.521025608234556*^9}, {3.521025666713138*^9, 3.521025678089415*^9}, {
   3.521025712132613*^9, 3.521025727713867*^9}, {3.521269581038597*^9, 
   3.521269605823536*^9}, {3.521269639262424*^9, 3.521269685929887*^9}, {
   3.521277233261158*^9, 3.521277234508263*^9}, {3.521318944562284*^9, 
   3.521318981109728*^9}, {3.5213582354598627`*^9, 3.52135824064916*^9}, 
   3.521360144054431*^9, {3.521399228536585*^9, 3.52139925196098*^9}, 
   3.521402170753791*^9, {3.521402319956094*^9, 3.521402320716485*^9}, {
   3.521404080894424*^9, 3.521404123261088*^9}, {3.521408252558969*^9, 
   3.521408287675741*^9}, {3.521408365683878*^9, 3.521408382242196*^9}, {
   3.521408412957183*^9, 3.521408434028697*^9}, {3.5214087522564*^9, 
   3.5214087846502943`*^9}, {3.521852371958218*^9, 3.521852373413932*^9}, {
   3.55235342250169*^9, 3.552353437167577*^9}, {3.552353472219611*^9, 
   3.552353482859745*^9}, {3.601317514732277*^9, 3.601317527247696*^9}, {
   3.601323003883316*^9, 3.601323055987219*^9}, {3.605908268036574*^9, 
   3.605908282062601*^9}, {3.621183765032989*^9, 3.621183851611827*^9}, {
   3.621183991623736*^9, 3.621183992067258*^9}, {3.621184023817616*^9, 
   3.621184054105504*^9}, {3.621184224181695*^9, 3.621184302362372*^9}, {
   3.621184344682077*^9, 3.621184448159368*^9}, 3.621185140078867*^9, {
   3.621198287388129*^9, 3.621198289070091*^9}, {3.636046286751202*^9, 
   3.636046355586553*^9}, {3.636046597374108*^9, 3.636046641698682*^9}, {
   3.636047184534328*^9, 3.636047190564961*^9}, {3.63604900719662*^9, 
   3.636049084939208*^9}, {3.6394655559580307`*^9, 3.6394655981876583`*^9}, {
   3.639467808852516*^9, 3.639467821539129*^9}, {3.639678365534047*^9, 
   3.639678435442706*^9}, {3.639678485177114*^9, 3.639678498018644*^9}, {
   3.639678572920928*^9, 3.639678613406626*^9}, {3.639678674573036*^9, 
   3.639678680322383*^9}, {3.639678987692088*^9, 3.639678990634227*^9}, {
   3.639679267882903*^9, 3.6396794752069063`*^9}, {3.639679828473807*^9, 
   3.639679832790675*^9}, {3.639850146297246*^9, 3.639850165217244*^9}, {
   3.639850206561096*^9, 3.63985021647855*^9}, 3.639850284780261*^9, {
   3.6398503176665*^9, 3.639850336847082*^9}, 3.639850534594743*^9, {
   3.639850588524793*^9, 3.63985059273084*^9}, {3.639850740964967*^9, 
   3.639850745269121*^9}, {3.639850850100329*^9, 3.639850853435318*^9}, {
   3.639851056387798*^9, 3.639851060392151*^9}, {3.639851416630632*^9, 
   3.639851424154266*^9}, {3.6398820557135143`*^9, 3.63988206526787*^9}, {
   3.639882155152216*^9, 3.639882191937891*^9}, 3.64005189806417*^9, {
   3.640052094949839*^9, 3.640052098496329*^9}, {3.640052239033099*^9, 
   3.640052309332191*^9}, {3.640052344561794*^9, 3.640052357363299*^9}, {
   3.640052399100091*^9, 3.640052479199299*^9}, {3.640052513708534*^9, 
   3.640052589834898*^9}, {3.6400526385072308`*^9, 3.640052677612921*^9}, {
   3.640052776799108*^9, 3.640052784188908*^9}, {3.927231451464964*^9, 
   3.927231452287071*^9}, 3.9341599992099676`*^9, {3.934160043341963*^9, 
   3.934160077414709*^9}, 3.934160162642437*^9, {3.93416234789148*^9, 
   3.934162706656887*^9}, {3.9341628907235985`*^9, 3.9341628919464474`*^9}},
 CellLabel->"In[2]:=",ExpressionUUID->"1cc186d6-fdd0-4027-b5d4-5d77ddc45b13"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Functions", "Section",
 CellChangeTimes->{{3.853962473086253*^9, 
  3.8539624738303223`*^9}},ExpressionUUID->"bbcf0f62-85ed-4f4f-bcec-\
da47360332b9"],

Cell[CellGroupData[{

Cell["List manipulation", "Subsection",
 CellChangeTimes->{{3.85396330551138*^9, 
  3.85396330849909*^9}},ExpressionUUID->"f948ffcc-e1ce-46d5-97a1-\
55041fda22c9"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"RuleToOpRule", "[", "rules_", "]"}], ":=", 
  RowBox[{"rules", "/.", 
   RowBox[{
    RowBox[{"Rule", "[", 
     RowBox[{"a_", ",", "b_"}], "]"}], "->", 
    RowBox[{"Rule", "[", 
     RowBox[{
      OverscriptBox["a", "^"], ",", "b"}], "]"}]}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RuleToOpRule", "::", "usage"}], "=", "\[IndentingNewLine]", 
   "\"\<RuleToOpRule[\!\(\*StyleBox[\"exp\",FontSlant->\"Italic\"]\)\!\(\*\
StyleBox[\"]\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\" \
\",FontSlant->\"Italic\"]\)Takes a list \
\!\(\*StyleBox[\"rules\",FontSlant->\"Italic\"]\) {\[Sigma]x\[Rule]a,...}, \
and returns {\!\(\*OverscriptBox[\(\[Sigma]x\), \(^\)]\)\[Rule]a,...}.\>\""}],
   ";"}]}], "Input",
 CellChangeTimes->{{3.85396265434221*^9, 3.853962679719483*^9}, {
   3.8539630531639833`*^9, 3.853963167235778*^9}, {3.853963358120053*^9, 
   3.853963395831749*^9}, 3.853964219608188*^9},
 CellLabel->"In[93]:=",ExpressionUUID->"d69e0537-72d1-4906-b66a-83d91b73f5b3"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Analysis", "Subsection",
 CellChangeTimes->{{3.85396333052995*^9, 
  3.853963332186397*^9}},ExpressionUUID->"ef77efab-3c4b-4cbb-951a-\
4c5ce2fd200c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Frob", "[", 
    RowBox[{"A_", ",", "B_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"Tr", "[", 
     RowBox[{"A", ".", 
      RowBox[{"ConjugateTranspose", "[", "B", "]"}]}], "]"}], "/", 
    RowBox[{"Length", "[", "A", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Frob", "[", "A_", "]"}], ":=", 
  SqrtBox[
   RowBox[{"Frob", "[", 
    RowBox[{"A", ",", "A"}], "]"}]]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Frob", "::", "usage"}], "=", "\[IndentingNewLine]", 
   "\"\<Frob[\!\(\*StyleBox[\"A\",FontSlant->\"Italic\"]\),\!\(\*StyleBox[\"B\
\",FontSlant->\"Italic\"]\)] returns the Frobenius inner product \
Tr[A.\!\(\*SuperscriptBox[\(B\), \(\[Dagger]\)]\)]/n. The dimension \
\!\(\*StyleBox[\"n\",FontSlant->\"Italic\"]\) is taken to be Length[A].\n\
Frob[A] returns the Frobeneius norm \!\(\*SqrtBox[\(Frob[A, A]\)]\)\>\""}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.853963567940799*^9, 3.853963694755217*^9}, {
  3.8539639300644383`*^9, 3.853963932128486*^9}, {3.8539641362983465`*^9, 
  3.8539641873207784`*^9}},
 CellLabel->"In[95]:=",ExpressionUUID->"9f734630-0b05-48df-9129-eacd1fc13b8a"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"OpCoefficients", "[", 
    RowBox[{"exp_", ",", 
     RowBox[{"mats_", ":", "\[Sigma]ListMats"}], ",", 
     RowBox[{"prod_", ":", "Frob"}]}], "]"}], ":=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"prod", "[", 
      RowBox[{"exp", ",", "\[Sigma]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"\[Sigma]", ",", "mats"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"OpCoefficients", "::", "usage"}], "=", "\[IndentingNewLine]", 
   "\"\<OpCoefficients[\!\(\*StyleBox[\"exp\",FontSlant->\"Italic\"]\),\!\(\*\
StyleBox[\"mats\",FontSlant->\"Italic\"]\),\!\(\*StyleBox[\"prod\",FontSlant->\
\"Italic\"]\)] Finds the coefficients of \
\!\(\*StyleBox[\"exp\",FontSlant->\"Italic\"]\) with respect to \
\!\(\*StyleBox[\"mats\",FontSlant->\"Italic\"]\), using the inner product \
\!\(\*StyleBox[\"prod\",FontSlant->\"Italic\"]\). \n* \
\!\(\*StyleBox[\"exp\",FontSlant->\"Italic\"]\) is an expression of matrices\n\
* \!\(\*StyleBox[\"mats\",FontSlant->\"Italic\"]\) is a list of matrices, \
which defaults to the Pauli matrices \
\!\(\*StyleBox[\"\[Sigma]ListMats\",FontSlant->\"Italic\"]\). \n* \
\!\(\*StyleBox[\"prod\",FontSlant->\"Italic\"]\) is an inner product, which \
defaults to Frobenius product \
\!\(\*StyleBox[\"Frob\",FontSlant->\"Italic\"]\)\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.853963333462016*^9, 3.853963352330823*^9}, {
   3.853963421489312*^9, 3.853963469293299*^9}, {3.8539639482596736`*^9, 
   3.8539639817723036`*^9}, {3.853964030068116*^9, 3.8539641336621165`*^9}, 
   3.853964168227598*^9, {3.8539642248168273`*^9, 3.853964227490965*^9}, {
   3.853964377341693*^9, 3.8539644050363245`*^9}},
 CellLabel->"In[98]:=",ExpressionUUID->"85103725-06b0-4380-885c-5b57389a1270"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Evaluation", "Subsection",
 CellChangeTimes->{{3.853963311691527*^9, 
  3.853963312866602*^9}},ExpressionUUID->"94414981-0235-4b48-aa9e-\
32a1beca9644"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"EvalOps", "[", 
   RowBox[{"exp_", ",", 
    RowBox[{"mats_", ":", "sub\[Sigma]"}]}], "]"}], ":=", 
  RowBox[{
   RowBox[{"ReplaceAll", "[", 
    RowBox[{"exp", ",", 
     RowBox[{"op", "->", "Dot"}]}], "]"}], "/.", 
   RowBox[{"RuleToOpRule", "[", "mats", "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"EvalOps", "::", "usage"}], " ", "=", " ", "\[IndentingNewLine]", 
   "\"\<EvalOps[\!\(\*StyleBox[\"exp\",FontSlant->\"Italic\"]\),\!\(\*\
StyleBox[\"mats\",FontSlant->\"Italic\"]\)] evalutes an expression \
\!\(\*StyleBox[\"exp\",FontSlant->\"Italic\"]\) of operators such as \
\!\(\*OverscriptBox[\(\[Sigma]x\), \(^\)]\)\[SmallCircle]\!\(\*OverscriptBox[\
\(\[Sigma]y\), \(^\)]\), using rules \
\!\(\*StyleBox[\"mats\",FontSlant->\"Italic\"]\) substituting the symbols for \
matrices. \!\(\*StyleBox[\"mats\",FontSlant->\"Italic\"]\) may represent the \
matrices with symbols like '\[Sigma]x', or operators '\!\(\*OverscriptBox[\(\
\[Sigma]x\), \(^\)]\)'. \!\(\*StyleBox[\"mats\",FontSlant->\"Italic\"]\) \
defaults to \
\!\(\*StyleBox[\"subPauli\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\":\",\
FontSlant->\"Italic\"]\) {\[Sigma]x\[Rule]({0,1},{1,0}),...}.\>\""}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.85396229619811*^9, 3.853962465864503*^9}, {
   3.853962541492699*^9, 3.853962562783634*^9}, {3.853962719083203*^9, 
   3.853963036692914*^9}, {3.853963101289435*^9, 3.853963106751827*^9}, {
   3.853963142336979*^9, 3.8539631591070027`*^9}, 3.853963252966939*^9, {
   3.853963483389824*^9, 3.853963484742128*^9}, 3.8539637183381305`*^9, {
   3.8539641698752065`*^9, 3.85396417131996*^9}},
 CellLabel->
  "In[100]:=",ExpressionUUID->"92d442eb-9250-4304-ad76-cc46918b34e7"],

Cell[BoxData[
 RowBox[{
  RowBox[{"WeylProduct", "[", "oplist_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"nops", ",", "perms"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"nops", " ", "=", " ", 
      RowBox[{"Length", "@", "oplist"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"Number", " ", "of", " ", "operators"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"perms", "=", 
      RowBox[{"Permutations", "[", 
       RowBox[{"oplist", ",", 
        RowBox[{"{", "nops", "}"}]}], "]"}]}]}]}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"All", " ", "nops"}], "-", 
     RowBox[{"element", " ", "permutations", " ", "of", " ", "oplist"}]}], 
    " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.859314588158921*^9, 3.8593146116077824`*^9}, {
  3.859314677681588*^9, 3.859314728517558*^9}},
 CellLabel->
  "In[102]:=",ExpressionUUID->"05153360-b700-406a-9c5e-d90e7156ec9f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Operator algebra", "Subsection",
 CellChangeTimes->{{3.927061787184452*^9, 
  3.927061788536648*^9}},ExpressionUUID->"077d87ef-e359-984f-b96e-\
8c7ce196257f"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"OpPower", "[", 
    RowBox[{"_", ",", "0"}], "]"}], ":=", "1"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"OpPower", "[", 
   RowBox[{"operator_", ",", "n_"}], "]"}], ":=", 
  RowBox[{"op", "@@", 
   RowBox[{"ConstantArray", "[", 
    RowBox[{"operator", ",", "n"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"OpPower", "::", "usage"}], "=", "\[IndentingNewLine]", 
   "\"\<OpPower[X,n] computes the nth power of X, assuming n is a positive \
integer\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.927061791442428*^9, 3.92706180680101*^9}, {
  3.927061918873291*^9, 3.927061963040985*^9}, {3.92706360337833*^9, 
  3.927063605913208*^9}, {3.92819604957112*^9, 3.928196055260075*^9}, {
  3.929137055539976*^9, 3.929137064965878*^9}},
 CellLabel->
  "In[103]:=",ExpressionUUID->"878f9bd8-dd0a-e648-af84-206a7187e322"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Computing Heisenberg EOM", "Section",
 CellChangeTimes->{{3.885669580348893*^9, 
  3.8856695838850527`*^9}},ExpressionUUID->"65506463-ab67-4ece-9806-\
60189c288b3e"],

Cell[CellGroupData[{

Cell["Basic manipulation", "Subsection",
 CellChangeTimes->{{3.885840932111186*^9, 
  3.8858409340738716`*^9}},ExpressionUUID->"43203384-45b1-48bf-b9ab-\
0446bd72aa09"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Convert", " ", "a", " ", "list", " ", "of", " ", "operators", " ", "to", 
    " ", "a", " ", "sum"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"OpSumToList", "[", "opSum_", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "opList", "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"Replace", " ", 
         RowBox[{"all", " ", "'"}]}], "+", 
        RowBox[{"'", " ", "operators", " ", "with", " ", "Lists"}]}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"opList", "=", 
        RowBox[{"ReplaceAll", "[", 
         RowBox[{
          RowBox[{"opSum", "//", "ExpandO"}], ",", 
          RowBox[{"Plus", "->", "List"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{
          RowBox[{
          "If", " ", "we", " ", "had", " ", "nested", " ", "sums", " ", 
           "like", " ", 
           OverscriptBox["a", "^"]}], "+", 
          RowBox[{
           OverscriptBox["b", "^"], "\[SmallCircle]", 
           RowBox[{"(", 
            RowBox[{
             OverscriptBox["c", "^"], "+", 
             OverscriptBox["d", "^"]}], ")"}]}]}], ",", " ", 
         RowBox[{
         "we", " ", "might", " ", "get", " ", "a", " ", "nested", " ", 
          "list"}], ",", " ", 
         RowBox[{
         "depending", " ", "on", " ", "how", " ", "Mathematica", " ", 
          "simplifes", " ", "the", " ", 
          RowBox[{"expression", ".", " ", "If"}], " ", "so", " ", "we", " ", 
          "need", " ", "to", " ", "flatten", " ", "the", " ", 
          RowBox[{"list", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Head", "@", "opList"}], "===", "List"}], ",", 
         RowBox[{"Flatten", "@", 
          RowBox[{"FullSimplify", "@", "opList"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{
           RowBox[{
           "If", " ", "we", " ", "just", " ", "had", " ", "a", " ", "single", 
            " ", "operator"}], ",", " ", 
           RowBox[{"return", " ", "a", " ", "single", " ", "element", " ", 
            RowBox[{"list", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"{", "opList", "}"}]}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpSumToList", "::", "usage"}], " ", "=", " ", 
     "\[IndentingNewLine]", 
     "\"\<OpSumToList[opSum] takes a sum of operators, and returns a list of \
each term in the sum. \nNote list elements are not necessarily gathered by \
operator, i.e. OpSumToList[x\!\(\*OverscriptBox[\(a\), \
\(^\)]\)+3\!\(\*OverscriptBox[\(a\), \(^\)]\)]={3\!\(\*OverscriptBox[\(a\), \
\(^\)]\),x\!\(\*OverscriptBox[\(a\), \(^\)]\)}\>\""}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{
     "Find", " ", "the", " ", "norm", " ", "of", " ", "a", " ", "product", 
      " ", "of", " ", "operators", " ", "such", " ", "as", " ", "3", "x", 
      RowBox[{
       RowBox[{
        OverscriptBox["a", "^"], "\[SmallCircle]", 
        OverscriptBox["b", "^"]}], ".", " ", "This"}], " ", "is", " ", "done",
       " ", "recursively", " ", "on", " ", "each", " ", "element", " ", "of", 
      " ", "the", " ", 
      RowBox[{"product", ".", " ", "We"}], " ", "use", " ", "different", " ", 
      "cases", " ", "to", " ", "handle", " ", "if", " ", "each", " ", 
      "element", " ", "is", " ", "a", " ", "scalar"}], ",", " ", "operator", 
     ",", " ", 
     RowBox[{"or", " ", 
      RowBox[{"product", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{
     "If", " ", "the", " ", "operator", " ", "is", " ", "a", " ", "scalar"}], 
     ",", " ", 
     RowBox[{"just", " ", "return", " ", "the", " ", "scalar"}]}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpNorm", "[", 
      RowBox[{"x_", "?", "NumberQ"}], "]"}], ":=", "x"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{"Products", " ", "of", " ", "operators", " ", 
       RowBox[{
        RowBox[{"using", " ", "'"}], "\[SmallCircle]", "'"}], " ", "are", " ",
        "represented", " ", "by", " ", 
       RowBox[{
        StyleBox[
         RowBox[{"op", "[", "]"}],
         FontSlant->"Italic"], ".", " ", "If"}], " ", "we", " ", "have", " ", 
       "a", " ", "product", " ", "like", " ", 
       RowBox[{
        OverscriptBox["a", "^"], "\[SmallCircle]", 
        OverscriptBox["b", "^"]}]}], ",", " ", 
      RowBox[{"return", " ", "a", " ", "norm", " ", "of", " ", "1."}]}], 
     " "}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpNorm", "[", "x_op", "]"}], ":=", "1"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"An", " ", "individual", " ", "operator", " ", "like", " ", 
     OverscriptBox["a", "^"], " ", "is", " ", "represented", " ", "by", " ", 
     RowBox[{
      StyleBox[
       RowBox[{"Operator", "[", "]"}],
       FontSlant->"Italic"], ".", " ", "This"}], " ", "has", " ", "a", " ", 
     "norm", " ", "of", " ", "1"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpNorm", "[", 
      RowBox[{"r_", " ", 
       RowBox[{"LOp", "[", 
        RowBox[{"a_", ",", "b_"}], "]"}]}], "]"}], ":=", "r"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpNorm", "[", "a_LOp", "]"}], ":=", "1"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpNorm", "[", "x_Operator", "]"}], ":=", "1"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{
     "Handles", " ", "a", " ", "scalar", " ", "times", " ", "an", " ", 
      "operator"}], ",", " ", 
     RowBox[{
     "returning", " ", "that", " ", "scalar", " ", "multiplied", " ", "by", 
      " ", "the", " ", 
      RowBox[{"operator", "'"}], "s", " ", "norm"}]}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpNorm", "[", "x_Times", "]"}], ":=", 
     RowBox[{"OpNorm", "/@", "x"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"If", " ", "x", " ", "is", " ", "a", " ", "symbol"}], ",", " ", 
     RowBox[{"return", " ", "that", " ", 
      RowBox[{"symbol", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpNorm", "[", "x_", "]"}], ":=", "x"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpNorm", "::", "usage"}], " ", "=", " ", "\[IndentingNewLine]", 
     "\"\<OpNorm[op_] returns the norm of an operator: \
OpNorm[3x\!\(\*OverscriptBox[\(a\), \
\(^\)]\)\[SmallCircle]\!\(\*OverscriptBox[\(b\), \(^\)]\)]=3x. If \
\!\(\*StyleBox[\"op\",FontSlant->\"Italic\"]\) is a scalar it will return \
\!\(\*StyleBox[\"op\",FontSlant->\"Italic\"]\). \nIf \
\!\(\*StyleBox[\"op\",FontSlant->\"Italic\"]\) is a sum it should return the \
sum unchanged, but I haven't robustly tested this.\>\""}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Normalize", " ", "an", " ", "operator"}], ",", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"i", ".", "e", ".", " ", "3"}], 
       RowBox[{
        OverscriptBox["a", "^"], "\[SmallCircle]", 
        OverscriptBox["b", "^"]}]}], " ", "->", " ", 
      RowBox[{
       OverscriptBox["a", "^"], "\[SmallCircle]", 
       OverscriptBox["b", "^"]}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"NormaliseOp", "[", "op_", "]"}], ":=", 
     RowBox[{"If", "[", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "If", " ", "op", " ", "is", " ", "a", " ", "sum", " ", "or", " ", 
         "zero"}], ",", " ", 
        RowBox[{"return", " ", "op", " ", 
         RowBox[{"unchanged", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Or", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "@", 
           RowBox[{"OpSumToList", "@", "op"}]}], ">", "1"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"op", "===", "0"}]}], "]"}], ",", "op", " ", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Otherwise", " ", "divide", " ", "the", " ", "term", " ", "by", " ", 
         "its", " ", "norm"}], " ", "*)"}], "\[IndentingNewLine]", ",", 
       RowBox[{"op", "/", 
        RowBox[{"OpNorm", "[", "op", "]"}]}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"NormaliseOp", "[", 
      RowBox[{"r_", " ", 
       RowBox[{"LOp", "[", 
        RowBox[{"a_", ",", "b_"}], "]"}]}], "]"}], ":=", 
     RowBox[{"LOp", "[", 
      RowBox[{"a", ",", "b"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"NormaliseOp", "::", "usage"}], "=", "\[IndentingNewLine]", 
     "\"\<NormaliseOp[op_] divides an operator by its norm: \
OpNorm[3x\!\(\*OverscriptBox[\(a\), \
\(^\)]\)\[SmallCircle]\!\(\*OverscriptBox[\(b\), \
\(^\)]\)]=\!\(\*OverscriptBox[\(a\), \
\(^\)]\)\[SmallCircle]\!\(\*OverscriptBox[\(b\), \(^\)]\).\n* If \
\!\(\*StyleBox[\"op\",FontSlant->\"Italic\"]\) is zero it will return zero.\n\
* If \!\(\*StyleBox[\"op\",FontSlant->\"Italic\"]\) is a sum it will be \
returned unchanged.\>\""}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.885669623381283*^9, 3.885669778565615*^9}, {
   3.885669817301861*^9, 3.885669900518842*^9}, {3.8856699377576103`*^9, 
   3.885670318069138*^9}, {3.885670392111062*^9, 3.885670470853836*^9}, {
   3.88567050567891*^9, 3.885670606406333*^9}, {3.885670683926784*^9, 
   3.885670809895228*^9}, {3.885670849630589*^9, 3.885670889015192*^9}, 
   3.885840907248523*^9, {3.8858417286751814`*^9, 3.8858417515502453`*^9}, {
   3.8858422581102667`*^9, 3.885842262451051*^9}, 3.885842416559184*^9, {
   3.88602311390714*^9, 3.886023114819545*^9}, {3.88602343232863*^9, 
   3.8860235336420326`*^9}, 3.8933761811450243`*^9, {3.8933766852171865`*^9, 
   3.893376710310469*^9}, {3.893376772436005*^9, 3.893376783093251*^9}},
 CellLabel->
  "In[106]:=",ExpressionUUID->"28dbff42-8e2e-48c5-b9a7-757f8c408665"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Decomposition", "Subsection",
 CellChangeTimes->{{3.885840947263025*^9, 
  3.885840948343955*^9}},ExpressionUUID->"cc134990-d28e-41b9-b778-\
1cdc3c442e73"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Find", " ", "the", " ", "position", " ", "of", " ", "operator", " ", "x", 
    " ", "in", " ", 
    RowBox[{"opList", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"OpBasisPosition", "[", 
      RowBox[{"op_", ",", "opList_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"opNormalised", ",", "pos"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"opNormalised", "=", 
         RowBox[{"NormaliseOp", "[", "op", "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Need", " ", "a", " ", "1", " ", "here", " ", "to", " ", "stop", " ", 
          OverscriptBox["a", "^"], " ", "matching", " ", 
          RowBox[{
           OverscriptBox["a", "^"], "\[SmallCircle]", 
           OverscriptBox["x", "^"]}]}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"pos", "=", 
         RowBox[{
          RowBox[{"Position", "[", 
           RowBox[{"opList", ",", "opNormalised", ",", "1"}], "]"}], "//", 
          "Flatten"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"Return", " ", "0", " ", "if", " ", "op", " ", 
          RowBox[{"wasn", "'"}], "t", " ", "found", " ", "in", " ", 
          "OpList"}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "pos", "]"}], "==", "1"}], ",", 
          RowBox[{"pos", "[", 
           RowBox[{"[", "1", "]"}], "]"}], ",", "0"}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpBasisPosition", "::", "usage"}], "=", "\[IndentingNewLine]", 
     "\"\<TermBasisPosition[\!\(\*StyleBox[\"op_\",FontSlant->\"Italic\"]\),\!\
\(\*StyleBox[\"opList_\",FontSlant->\"Italic\"]\)] returns an index \
corresponding to the position of operator \
\!\(\*StyleBox[\"op\",FontSlant->\"Italic\"]\) in a list of operators \
\!\(\*StyleBox[\"opList\",FontSlant->\"Italic\"]\). It assumes every operator \
in \!\(\*StyleBox[\"opList\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\" \
\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\"is\",FontSlant->\"Plain\"]\)\!\(\*\
StyleBox[\" \
\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\"normalised\",FontSlant->\"Plain\"]\
\)\!\(\*StyleBox[\",\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\" \
\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\"and\",FontSlant->\"Plain\"]\)\!\(\*\
StyleBox[\" \
\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\"will\",FontSlant->\"Plain\"]\)\!\(\
\*StyleBox[\" \
\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\"automatically\",FontSlant->\"Plain\
\"]\)\!\(\*StyleBox[\" \
\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\"normalise\",FontSlant->\"Plain\"]\)\
\!\(\*StyleBox[\" \",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\"op\",FontSlant->\
\"Italic\"]\). If \!\(\*StyleBox[\"op\",FontSlant->\"Italic\"]\) is not in \!\
\(\*StyleBox[\"opList\",FontSlant->\"Italic\"]\), an index of 0 is \
returned.\>\""}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{
     "Decompose", " ", "a", " ", "sum", " ", "of", " ", "operators", " ", 
      "in", " ", "terms", " ", "of", " ", "a", " ", "list"}], ",", " ", 
     RowBox[{
     "returning", " ", "the", " ", "coefficients", " ", "and", " ", 
      "indexes"}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpSumListDecomposition", "[", 
      RowBox[{"opSum_", ",", "opList_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"sum", ",", "decomp"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
        "Get", " ", "a", " ", "list", " ", "of", " ", "operators", " ", "in", 
         " ", "the", " ", "sum"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"sum", " ", "=", " ", 
         RowBox[{"OpSumToList", "[", "opSum", "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"{", 
          RowBox[{"norm", ",", " ", "index"}], "}"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"decomp", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"OpNorm", "@", "#"}], ",", 
             RowBox[{"OpBasisPosition", "[", 
              RowBox[{"#", ",", "opList"}], "]"}]}], "}"}], "&"}], "/@", 
          "sum"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "Merge", " ", "elements", " ", "in", " ", "list", " ", 
          "corresponding", " ", "to", " ", "the", " ", "same", " ", "algebra",
           " ", "element"}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Plus", "@@", 
             RowBox[{"#", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], ",", 
            RowBox[{"First", "@", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}]}], "}"}], "&"}], "/@", 
         RowBox[{"(", 
          RowBox[{"Transpose", "/@", 
           RowBox[{"GatherBy", "[", 
            RowBox[{"decomp", ",", "Last"}], "]"}]}], ")"}]}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"OpSumListDecomposition", "::", "usage"}], "=", 
     "\[IndentingNewLine]", 
     "\"\<OpListDecomposition[\!\(\*StyleBox[\"opSum_\",FontSlant->\"Italic\"]\
\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"opList_\",\
FontSlant->\"Italic\"]\)] takes a sum of operators \
\!\(\*StyleBox[\"opSum\",FontSlant->\"Italic\"]\), and returns a list \
{{\!\(\*StyleBox[\"norm1\",FontSlant->\"Italic\"]\),\!\(\*StyleBox[\"index1\",\
FontSlant->\"Italic\"]\)},} where \!\(\*StyleBox[\"norm\",FontSlant->\"Italic\
\"]\) is the norm of an element and \
\!\(\*StyleBox[\"index\",FontSlant->\"Italic\"]\) its position in \
\!\(\*StyleBox[\"opList\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\".\",\
FontSlant->\"Plain\"]\)\!\(\*StyleBox[\"\\\\n\",FontSlant->\"Plain\"]\)\!\(\*\
StyleBox[\"*\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\" \",FontSlant->\"Plain\
\"]\)\!\(\*StyleBox[\"opSum\",FontSlant->\"Italic\"]\) can include 1 to \
represent the identity element.\n* If an operator is not in \
\!\(\*StyleBox[\"opList\",FontSlant->\"Italic\"]\), it will have an \
\!\(\*StyleBox[\"index\",FontSlant->\"Italic\"]\) of 0.\>\""}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"OpSumDecompositionToXj", "[", "decomp_", "]"}], ":=", 
    RowBox[{"Plus", "@@", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{
         RowBox[{"#", "[", 
          RowBox[{"[", "1", "]"}], "]"}], 
         SubscriptBox["X", 
          RowBox[{"#", "[", 
           RowBox[{"[", "2", "]"}], "]"}]]}], "&"}], "/@", "decomp"}], 
      ")"}]}]}]}]}]], "Input",
 CellChangeTimes->{{3.885840966911085*^9, 3.885841190298218*^9}, 
   3.8858412615396547`*^9, {3.885841299347205*^9, 3.885841408756255*^9}, {
   3.885841635944464*^9, 3.885841684549535*^9}, {3.885841782632903*^9, 
   3.885841827442884*^9}, {3.885842038540042*^9, 3.88584213519694*^9}, {
   3.885842463020407*^9, 3.885842478604357*^9}, {3.885842532459442*^9, 
   3.885842568267914*^9}, {3.8858427082885027`*^9, 3.8858427309249277`*^9}, {
   3.886028872348446*^9, 3.886028919142476*^9}, {3.893379304345077*^9, 
   3.8933793045749035`*^9}},
 CellLabel->
  "In[119]:=",ExpressionUUID->"3f2d6b1c-f09c-4be6-91a0-029930531cbc"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Lie algebra analysis", "Subsection",
 CellChangeTimes->{{3.859313803925439*^9, 
  3.8593138077425838`*^9}},ExpressionUUID->"2aee7465-ec7c-4239-bd15-\
1d1e0fc98a3d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "AlgCommTable", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"ShowTable", "->", "True"}], ",", 
     RowBox[{"ShowOps", "->", "True"}], ",", 
     RowBox[{"Xj", "->", "False"}], ",", 
     RowBox[{"XjFromZero", "->", "False"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"AlgCommTable", "[", 
     RowBox[{"algebra_", ",", 
      RowBox[{"opt", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], ":=", 
    RowBox[{"AlgCommTable", "[", 
     RowBox[{"algebra", ",", "algebra", ",", 
      RowBox[{"Evaluate", "@", "opt"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"AlgCommTable", "[", 
   RowBox[{"algebra_", ",", "ideal_", ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "optable", "}"}], ",", "\[IndentingNewLine]", 
    "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"OptionValue", "[", "Title", "]"}], ",", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Commutator table for \>\"", ",", "opList"}], "]"}]}], 
       "]"}], ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"optable", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"comm", "[", 
          RowBox[{"o1", ",", "o2"}], "]"}], "//", "FullSimplify"}], ",", 
        RowBox[{"{", 
         RowBox[{"o1", ",", "algebra"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"o2", ",", "ideal"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Which", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"OptionValue", "@", "Xj"}], ",", 
       RowBox[{"optable", "=", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"OpSumDecompositionToXj", "@", 
            RowBox[{"OpSumListDecomposition", "[", 
             RowBox[{"#", ",", "algebra"}], "]"}]}], "&"}], ",", "optable", 
          ",", 
          RowBox[{"{", "2", "}"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{"OptionValue", "@", "ShowOps"}], ",", 
       RowBox[{"optable", "=", 
        RowBox[{"ShowOp", "@", "optable"}]}]}], "\[IndentingNewLine]", "]"}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"optable", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"OptionValue", "@", "ShowTable"}], ",", "\[IndentingNewLine]",
         "\[IndentingNewLine]", 
        RowBox[{"TableForm", "[", 
         RowBox[{"optable", ",", "\[IndentingNewLine]", 
          RowBox[{"Which", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"OptionValue", "@", "Xj"}], ",", 
            RowBox[{"TableHeadings", "->", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{
                RowBox[{
                 SubscriptBox["X", "#"], "&"}], "/@", 
                RowBox[{"Range", "@", 
                 RowBox[{"Length", "@", "algebra"}]}]}], ",", 
               RowBox[{
                RowBox[{
                 SubscriptBox["X", "#"], "&"}], "/@", 
                RowBox[{"Range", "@", 
                 RowBox[{"Length", "@", "ideal"}]}]}]}], "}"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"OptionValue", "@", "ShowOps"}], ",", 
            RowBox[{"TableHeadings", "->", 
             RowBox[{"ShowOp", "@", 
              RowBox[{"{", 
               RowBox[{"algebra", ",", "ideal"}], "}"}]}]}], ",", 
            "\[IndentingNewLine]", "True", ",", 
            RowBox[{"TableHeadings", "->", 
             RowBox[{"{", 
              RowBox[{"algebra", ",", "ideal"}], "}"}]}]}], "]"}]}], 
         "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", "optable"}], "\[IndentingNewLine]", "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "@", "XjFromZero"}], ",", 
       RowBox[{"optable", "=", 
        RowBox[{"optable", "/.", 
         RowBox[{
          SubscriptBox["X", "j_"], "->", 
          SubscriptBox["X", 
           RowBox[{"j", "-", "1"}]]}]}]}]}], "]"}], ";", 
     "\[IndentingNewLine]", "optable"}]}], "\[IndentingNewLine]", 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"AlgCommTable", "::", "usage"}], "=", "\[IndentingNewLine]", 
   "\"\<AlgCommTable[oplist,ShowTable->True] returns the commutator table for \
a list of operators, using FullSimplify@co.\n* \
\!\(\*StyleBox[\"opList\",FontSlant->\"Italic\"]\) is a list of operators\n* \
If \!\(\*StyleBox[\"ShowTable\",FontSlant->\"Italic\"]\) is False the raw \
table is returned, otherwise a nice table is displayed.\n* \
\!\(\*StyleBox[\"Title\",FontSlant->\"Italic\"]\) controls if a title \
'Commutator table for {oplist}' is displayed.\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.859313815639618*^9, 3.859314180101961*^9}, {
   3.859314401504188*^9, 3.85931443409778*^9}, {3.8858445272706337`*^9, 
   3.8858445507513695`*^9}, {3.885844644290745*^9, 3.885844692884412*^9}, {
   3.88584472815743*^9, 3.88584473716341*^9}, {3.885844975987867*^9, 
   3.885845041138495*^9}, {3.8858456165673723`*^9, 3.885845737638015*^9}, {
   3.885845782422218*^9, 3.88584578936025*^9}, {3.885845851235*^9, 
   3.8858458540013833`*^9}, {3.885846009599685*^9, 3.885846102654034*^9}, {
   3.885846138074982*^9, 3.885846207496457*^9}, {3.8858462402307343`*^9, 
   3.885846311855959*^9}, {3.885846366402882*^9, 3.885846406891491*^9}, {
   3.885846482457549*^9, 3.885846486836188*^9}, {3.8858465262044168`*^9, 
   3.885846582373011*^9}, {3.88584662894902*^9, 3.885846664861959*^9}, {
   3.885846747194885*^9, 3.885846761996231*^9}, {3.885846793603509*^9, 
   3.885846813180635*^9}, {3.885846879137477*^9, 3.885846884702866*^9}, {
   3.885846937482072*^9, 3.885846950182188*^9}, {3.8858470475071216`*^9, 
   3.885847103687948*^9}, {3.8858481613975773`*^9, 3.885848197705848*^9}, {
   3.885848233759002*^9, 3.885848371801001*^9}, {3.885848426681824*^9, 
   3.885848429099944*^9}, {3.885848701864044*^9, 3.8858487047164*^9}, {
   3.885972690729691*^9, 3.8859727005130715`*^9}, {3.89336660475112*^9, 
   3.8933666061033106`*^9}, {3.8933666828798637`*^9, 3.893366831961334*^9}, 
   3.893367022155372*^9, {3.893379175727127*^9, 3.8933791850486*^9}, {
   3.8933793171075*^9, 3.8933793213341084`*^9}, {3.893379358161649*^9, 
   3.8933794545709352`*^9}, {3.8933794882003407`*^9, 3.893379489467124*^9}, {
   3.893381950285773*^9, 3.893382056523023*^9}, {3.893382206318204*^9, 
   3.893382378555073*^9}, {3.893382436194715*^9, 3.89338243636536*^9}, {
   3.89338249425552*^9, 3.893382623646948*^9}, {3.893382679083511*^9, 
   3.89338268160446*^9}, {3.893382721869473*^9, 3.893382744823246*^9}, {
   3.893382795561651*^9, 3.893382820952828*^9}, {3.893382855960553*^9, 
   3.893382919096259*^9}, {3.893383075536218*^9, 3.89338314687335*^9}, {
   3.8943418760856304`*^9, 3.894341885361766*^9}, {3.9063460188890457`*^9, 
   3.906346138441151*^9}, {3.9063463564742365`*^9, 3.9063463568811007`*^9}, {
   3.906346405353735*^9, 3.9063464076176553`*^9}, {3.906346447545618*^9, 
   3.906346488992769*^9}, {3.9063465446106925`*^9, 3.9063465446614676`*^9}, {
   3.906347126993951*^9, 3.9063471305529647`*^9}},
 CellLabel->
  "In[124]:=",ExpressionUUID->"852c7d7e-aecf-41f8-b3fa-1e7932f989ac"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Structure constants", "Subsection",
 CellChangeTimes->{{3.885848438657022*^9, 
  3.8858484402718883`*^9}},ExpressionUUID->"ff8fdb72-1ff2-4c9a-bca1-\
f79e0d667c0d"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"Return", " ", 
    SuperscriptBox[
     SubscriptBox["\[CapitalGamma]", "jk"], "m"]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"AlgStructure\[CapitalGamma]", "[", 
      RowBox[{
      "j_", ",", "k_", ",", "m_", ",", "hAlgebra_", ",", "opAlgebra_"}], 
      "]"}], ":=", 
     RowBox[{"Module", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"commutatorjk", ",", "decomp", ",", "decompk"}], "}"}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"commutatorjk", "=", 
         RowBox[{"FullSimplify", "@", 
          RowBox[{"co", "[", 
           RowBox[{
            RowBox[{"hAlgebra", "[", 
             RowBox[{"[", "j", "]"}], "]"}], ",", 
            RowBox[{"opAlgebra", "[", 
             RowBox[{"[", "k", "]"}], "]"}]}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"decomp", "=", 
         RowBox[{"OpSumListDecomposition", "[", 
          RowBox[{"commutatorjk", ",", "opAlgebra"}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"decompk", "=", 
         RowBox[{"Select", "[", 
          RowBox[{"decomp", ",", 
           RowBox[{
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}], "==", "m"}], "&"}]}], "]"}]}], 
        ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "decompk", "]"}], "==", "1"}], ",", 
          RowBox[{"decompk", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}], ",", "0"}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"AlgStructure\[CapitalGamma]", "[", 
      RowBox[{"j_", ",", "k_", ",", "m_", ",", "opAlgebra_"}], "]"}], ":=", 
     RowBox[{"AlgStructure\[CapitalGamma]", "[", 
      RowBox[{"j", ",", "k", ",", "m", ",", "opAlgebra", ",", "opAlgebra"}], 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"AlgStructure\[CapitalGamma]", "::", "usage"}], "=", 
     "\[IndentingNewLine]", 
     "\"\<AlgStructure\[CapitalGamma][\!\(\*StyleBox[\"j_\",FontSlant->\"\
Italic\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"k_\",\
FontSlant->\"Italic\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*\
StyleBox[\"m_\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\",\",FontSlant->\"\
Italic\"]\)\!\(\*StyleBox[\"hAlgebra_\",FontSlant->\"Italic\"]\)\!\(\*\
StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"opAlgebra_\",\
FontSlant->\"Italic\"]\)] returns \!\(\*SuperscriptBox[SubscriptBox[\(\
\[CapitalGamma]\), \(jk\)], \(m\)]\) which is [\!\(\*SubscriptBox[\(X\), \
\(j\)]\),\!\(\*SubscriptBox[\(X\), \(k\)]\)] projected onto element \
\!\(\*SubscriptBox[\(X\), \(m\)]\), where \!\(\*SubscriptBox[\(X\), \(j\)]\),\
\!\(\*SubscriptBox[\(X\), \(k\)]\) are elements of \
\!\(\*StyleBox[\"hAlgebra\",FontSlant->\"Italic\"]\),\!\(\*StyleBox[\"\
opAlgebra\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\" \
\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\"respectively\",FontSlant->\"Plain\"\
]\)\!\(\*StyleBox[\",\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\" \
\",FontSlant->\"Plain\"]\)\!\(\*StyleBox[\"and\",FontSlant->\"Plain\"]\)\!\(\*\
StyleBox[\" \
\",FontSlant->\"Plain\"]\)\!\(\*SubscriptBox[StyleBox[\"X\",FontSlant->\"\
Plain\"], \"m\"]\) is in \
\!\(\*StyleBox[\"opAlgebra\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\".\",\
FontSlant->\"Plain\"]\)\n\
AlgStructure\[CapitalGamma][\!\(\*StyleBox[\"j_\",FontSlant->\"Italic\"]\)\!\(\
\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"k_\",FontSlant->\"\
Italic\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"m_\",\
FontSlant->\"Italic\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*\
StyleBox[\"opAlgebra_\",FontSlant->\"Italic\"]\)] returns the same as above, \
taking \!\(\*StyleBox[\"hAlgebra\",FontSlant->\"Italic\"]\) to be equal to \!\
\(\*StyleBox[\"opAlgebra\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\".\",\
FontSlant->\"Plain\"]\)\>\""}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"AlgStructure\[CapitalGamma]jk", "[", 
     RowBox[{"j_", ",", "k_", ",", "hAlgebra_", ",", "opAlgebra_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "\[CapitalGamma]jk", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"\[CapitalGamma]jk", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"AlgStructure\[CapitalGamma]", "[", 
          RowBox[{
          "j", ",", "k", ",", "m", ",", "hAlgebra", ",", "opAlgebra"}], "]"}],
          ",", 
         RowBox[{"{", 
          RowBox[{"m", ",", "1", ",", 
           RowBox[{"Length", "@", "opAlgebra"}]}], "}"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"AlgStructure\[CapitalGamma]jk", "[", 
     RowBox[{"j_", ",", "k_", ",", "opAlgebra_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "\[CapitalGamma]jk", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"\[CapitalGamma]jk", "=", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"AlgStructure\[CapitalGamma]", "[", 
          RowBox[{
          "j", ",", "k", ",", "m", ",", "opAlgebra", ",", "opAlgebra"}], 
          "]"}], ",", 
         RowBox[{"{", 
          RowBox[{"m", ",", "1", ",", 
           RowBox[{"Length", "@", "opAlgebra"}]}], "}"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"AlgStructure\[CapitalGamma]jk", "::", "usage"}], "=", 
     "\[IndentingNewLine]", 
     "\"\<AlgStructure\[CapitalGamma]jk[\!\(\*StyleBox[\"j_\",FontSlant->\"\
Italic\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"k_\",\
FontSlant->\"Italic\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*\
StyleBox[\"opAlgebra_\",FontSlant->\"Italic\"]\)] returns a list of \
\!\(\*SuperscriptBox[SubscriptBox[\(\[CapitalGamma]\), \(jk\)], \(m\)]\) for \
each m in \!\(\*StyleBox[\"opAlgebra\",FontSlant->\"Italic\"]\), where \
\!\(\*SuperscriptBox[SubscriptBox[\(\[CapitalGamma]\), \(jk\)], \(m\)]\) is \
AlgStructre\[CapitalGamma]\>\""}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Options", "[", "AlgStructure\[CapitalGamma]j", "]"}], "=", 
     RowBox[{"{", 
      RowBox[{"ShowTable", "->", "True"}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"AlgStructure\[CapitalGamma]j", "[", 
     RowBox[{"j_", ",", "opAlgebra_", ",", 
      RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "\[CapitalGamma]jk", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"\[CapitalGamma]jk", "=", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"AlgStructure\[CapitalGamma]", "[", 
           RowBox[{"j", ",", "k", ",", "m", ",", "opAlgebra"}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"k", ",", "1", ",", 
            RowBox[{"Length", "@", "opAlgebra"}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"m", ",", "1", ",", 
            RowBox[{"Length", "@", "opAlgebra"}]}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"OptionValue", "[", "ShowTable", "]"}], ",", 
         RowBox[{"TableForm", "[", 
          RowBox[{"\[CapitalGamma]jk", ",", 
           RowBox[{"TableHeadings", "->", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{
               RowBox[{
                SubscriptBox["\[CapitalGamma]", 
                 RowBox[{
                  RowBox[{"opAlgebra", "[", 
                   RowBox[{"[", "j", "]"}], "]"}], ",", "#"}]], "&"}], "/@", 
               "opAlgebra"}], ",", "opAlgebra"}], "}"}]}]}], "]"}], ",", 
         "\[CapitalGamma]jk"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"AlgStructure\[CapitalGamma]j", "::", "usage"}], "=", 
     "\[IndentingNewLine]", 
     "\"\<AlgStructure\[CapitalGamma]k[\!\(\*StyleBox[\"j_\",FontSlant->\"\
Italic\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"\
opAlgebra_\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\
\"]\)\!\(\*StyleBox[\"ShowTable\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"->\
\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"True\",FontSlant->\"Italic\"]\)] \
returns a table of \!\(\*SuperscriptBox[SubscriptBox[\(\[CapitalGamma]\), \
\(jk\)], \(m\)]\) for each m in \
\!\(\*StyleBox[\"opAlgebra\",FontSlant->\"Italic\"]\), where \
\!\(\*SuperscriptBox[SubscriptBox[\(\[CapitalGamma]\), \(jk\)], \(m\)]\) is \
AlgStructre\[CapitalGamma]. The columns correspond to m, and the rows to k. \
If ShowTable->True it will be shown in table form, otherwise a list will be \
returned\>\""}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Show", " ", "the", " ", "full", " ", "algebra", " ", "structure"}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"AlgStructure\[CapitalGamma]Full", "[", "opAlgebra_", "]"}], ":=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"AlgStructure\[CapitalGamma]j", "[", 
        RowBox[{"j", ",", "opAlgebra"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "1", ",", 
         RowBox[{"Length", "[", "opAlgebra", "]"}]}], "}"}]}], "]"}]}], ";"}],
    "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"AlgStructure\[CapitalGamma]Full", "::", "usage"}], "=", 
     "\[IndentingNewLine]", 
     "\"\<AlgStructure\[CapitalGamma]Full[\!\(\*StyleBox[\"opAlgebra_\",\
FontSlant->\"Italic\"]\)] prints the tables for the structure constants \
\!\(\*SuperscriptBox[SubscriptBox[\(\[CapitalGamma]\), \(jk\)], \
\(m\)]\)\>\""}], ";"}]}]}]], "Input",
 CellChangeTimes->{{3.885848663794978*^9, 3.885848665600627*^9}, {
  3.885934897219724*^9, 3.885934943143139*^9}},
 CellLabel->
  "In[128]:=",ExpressionUUID->"7529e6e4-f4be-45a0-b75e-5a0abc089166"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Hamiltonian", "Subsection",
 CellChangeTimes->{{3.885842733574834*^9, 3.8858427364618607`*^9}, {
  3.885843518177557*^9, 
  3.885843519655959*^9}},ExpressionUUID->"186ef421-dfcc-40ba-a495-\
41c4fcead439"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"MakeLieH", "[", 
   RowBox[{"hcoeffs_", ",", "hAlgebra_", ",", "opAlgebra_"}], "]"}], ":=", 
  RowBox[{"Table", "[", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Sum", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"hcoeffs", "[", 
        RowBox[{"[", "l", "]"}], "]"}], 
       RowBox[{"AlgStructure\[CapitalGamma]", "[", 
        RowBox[{"l", ",", "j", ",", "k", ",", "hAlgebra", ",", "opAlgebra"}], 
        "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"l", ",", "1", ",", 
        RowBox[{"Length", "@", "hcoeffs"}]}], "}"}]}], "]"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"{", 
     RowBox[{"j", ",", "1", ",", 
      RowBox[{"Length", "@", "opAlgebra"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{"k", ",", "1", ",", 
      RowBox[{"Length", "@", "opAlgebra"}]}], "}"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MakeLieH", "::", "usage"}], "=", "\[IndentingNewLine]", 
   "\"\<MakeLieH[\!\(\*StyleBox[\"hcoeffs_\",FontSlant->\"Italic\"]\)\!\(\*\
StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"hAlgebra_\",FontSlant-\
>\"Italic\"]\)\!\(\*StyleBox[\",\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"\
opAlgebra_\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"]\",FontSlant->\"Italic\
\"]\)\!\(\*StyleBox[\" \
\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"generates\",FontSlant->\"Italic\"]\
\)\!\(\*StyleBox[\" \
\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"the\",FontSlant->\"Italic\"]\)\!\(\
\*StyleBox[\" \
\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"Lie\",FontSlant->\"Italic\"]\)\!\(\
\*StyleBox[\" \
\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"algebra\",FontSlant->\"Italic\"]\)\
\!\(\*StyleBox[\" \
\",FontSlant->\"Italic\"]\)\!\(\*StyleBox[\"Hamiltonian\",FontSlant->\"Italic\
\"]\)\!\(\*StyleBox[\".\",FontSlant->\"Italic\"]\)\>\""}], ";"}]}], "Input",
 CellChangeTimes->{{3.8858485105315523`*^9, 3.885848557457844*^9}},
 CellLabel->
  "In[139]:=",ExpressionUUID->"963fde70-56d7-47a2-930e-7db3a31565ee"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "MakeLieEOM", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"NaturalUnits", "->", "True"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"MakeLieEOM", "[", 
   RowBox[{"hcoeffs_", ",", "hAlgebra_", ",", "opAlgebra_", ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"HMat", ",", "ut", ",", "u0", ",", "dut", ",", "hb"}], "}"}], 
    ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"(*", " ", 
     RowBox[{"Construct", " ", "the", " ", "Hamiltonian"}], " ", "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"HMat", "=", 
      RowBox[{"MakeLieH", "[", 
       RowBox[{"hcoeffs", ",", "hAlgebra", ",", "opAlgebra"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"Coefficients", " ", 
       RowBox[{"u", "[", 
        RowBox[{"l", ",", "t"}], "]"}], " ", "for", " ", "the", " ", "lth", 
       " ", "Lie", " ", "algebra", " ", "element"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"ut", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"u", "[", 
         RowBox[{"j", ",", "k", ",", "t"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "@", "opAlgebra"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"k", ",", "1", ",", 
          RowBox[{"Length", "@", "opAlgebra"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"Initial", " ", "condition"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"u0", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"u", "[", 
          RowBox[{"j", ",", "k", ",", "0"}], "]"}], "==", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"j", "==", "k"}], ",", "1", ",", "0"}], "]"}]}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "@", "opAlgebra"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"k", ",", "1", ",", 
          RowBox[{"Length", "@", "opAlgebra"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"hb", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"OptionValue", "[", "NaturalUnits", "]"}], ",", "1", ",", 
        "\[HBar]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dut", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"D", "[", 
          RowBox[{
           RowBox[{"ut", "[", 
            RowBox[{"[", 
             RowBox[{"j", ",", "k"}], "]"}], "]"}], ",", "t"}], "]"}], "==", 
         RowBox[{
          FractionBox["\[ImaginaryI]", "hb"], " ", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"HMat", ".", "ut"}], ")"}], "[", 
           RowBox[{"[", 
            RowBox[{"j", ",", "k"}], "]"}], "]"}]}]}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", 
          RowBox[{"Length", "@", "opAlgebra"}]}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"k", ",", "1", ",", 
          RowBox[{"Length", "@", "opAlgebra"}]}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"{", 
      RowBox[{"ut", ",", 
       RowBox[{"Join", "[", 
        RowBox[{"u0", ",", "dut"}], "]"}]}], "}"}]}]}], "\[IndentingNewLine]",
    "]"}]}]}], "Input",
 CellChangeTimes->{{3.885848800923472*^9, 3.885848989247116*^9}, {
  3.885849021616925*^9, 3.885849022692675*^9}, {3.8858490548515873`*^9, 
  3.885849113022253*^9}, {3.885849307259783*^9, 3.885849323682399*^9}, {
  3.8858493591475363`*^9, 3.885849394147525*^9}, {3.8858496068823013`*^9, 
  3.885849685713649*^9}, {3.885849776104688*^9, 3.88584977789868*^9}, {
  3.8859304658035116`*^9, 3.8859305097172403`*^9}, {3.8859305555122294`*^9, 
  3.8859305594406*^9}, {3.892760054133233*^9, 3.8927600604168158`*^9}, {
  3.922238557999647*^9, 3.922238619266731*^9}},
 CellLabel->
  "In[141]:=",ExpressionUUID->"e744eaaa-0894-4ce4-9d0a-6ec1cdc5ee22"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Reduced algebra generated by Hamiltonian", "Subsection",
 CellChangeTimes->{{3.8859325647293854`*^9, 3.8859325667661347`*^9}, {
  3.885933707745885*^9, 3.885933713267317*^9}, {3.8859344805984178`*^9, 
  3.885934481444454*^9}},ExpressionUUID->"1d9dd80e-c79b-4f9b-b22d-\
cca54a8b8884"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "Find", " ", "the", " ", "elements", " ", "generated", " ", "by", " ", 
     "the", " ", "commutator", " ", "of", " ", "hAlgebra", " ", "when", " ", 
     "applied", " ", "to", " ", 
     RowBox[{"opAlgebra", ".", " ", "Only"}], " ", "returns", " ", "elements",
      " ", "of", " ", "the", " ", "commutator"}], ",", " ", 
    RowBox[{"not", " ", "opAlgebra"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"DiffByHAlg", "[", 
     RowBox[{"hAlgebra_", ",", "opAlgebra_"}], "]"}], ":=", 
    "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"commutators", ",", "opList"}], "}"}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "If", " ", "opAlgebra", " ", "consists", " ", "of", " ", "a", " ", 
         "single", " ", "element"}], ",", " ", 
        RowBox[{"wrap", " ", "it", " ", "in", " ", "a", " ", "List"}]}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"opList", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Head", "@", "opAlgebra"}], "===", "List"}], ",", 
          "opAlgebra", ",", 
          RowBox[{"{", "opAlgebra", "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"commutators", "=", 
        RowBox[{"Flatten", "@", 
         RowBox[{"Table", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"OpSumToList", "@", 
            RowBox[{"Expand", "[", 
             RowBox[{"comm", "[", 
              RowBox[{"h", ",", "o"}], "]"}], "]"}]}], "\[IndentingNewLine]", 
           ",", 
           RowBox[{"{", 
            RowBox[{"h", ",", "hAlgebra"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"o", ",", "opList"}], "}"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"DeleteCases", "[", 
        RowBox[{
         RowBox[{"DeleteDuplicates", "[", 
          RowBox[{"NormaliseOp", "/@", "commutators"}], "]"}], ",", "0"}], 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Expand", " ", "opAlgebra", " ", "with", " ", "the", " ", "elements", " ",
      "generated", " ", "by", " ", "a", " ", "commutator", " ", "with", " ", 
     "hAlgebra"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"ExpandByHAlg", "[", 
     RowBox[{"hAlgebra_", ",", "opAlgebra_", ",", 
      RowBox[{"n_", ":", "1"}]}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "opList", "}"}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"opList", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Head", "@", "opAlgebra"}], "===", "List"}], ",", 
          "opAlgebra", ",", 
          RowBox[{"{", "opAlgebra", "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Nest", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"DeleteDuplicates", "[", 
           RowBox[{"Join", "[", 
            RowBox[{"#", ",", 
             RowBox[{"DiffByHAlg", "[", 
              RowBox[{"hAlgebra", ",", "#"}], "]"}]}], "]"}], "]"}], "&"}], 
         ",", "\[IndentingNewLine]", "opList", ",", "n"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.885932608134995*^9, 3.885932691600528*^9}, {
  3.885932756191433*^9, 3.885932758119179*^9}, {3.8859328142915382`*^9, 
  3.8859328200119514`*^9}, {3.8859328522267685`*^9, 3.8859328991091957`*^9}, {
  3.885933022941935*^9, 3.8859330807462*^9}, {3.885933116686574*^9, 
  3.885933117088167*^9}, {3.885933150351079*^9, 3.8859333347669992`*^9}, {
  3.885933376146456*^9, 3.8859333911222715`*^9}, {3.894338798159341*^9, 
  3.894338798317503*^9}},
 CellLabel->
  "In[143]:=",ExpressionUUID->"0c22332f-fbf5-4d1c-bfcc-2dc14fcff68b"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Adjoint representation", "Subsection",
 CellChangeTimes->{{3.885972560354255*^9, 
  3.885972564297269*^9}},ExpressionUUID->"27c9be0d-9075-470b-9bf4-\
787988b9f0d4"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Construct", " ", "adjoint", " ", "representation", " ", "of", " ", "Lie", 
    " ", "algebra"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"AdjointRep", "[", "algebra_", "]"}], ":=", 
     RowBox[{"AdjointRep", "[", 
      RowBox[{"algebra", ",", "algebra"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Adjoint", " ", "representation", " ", "on", " ", "an", " ", "ideal"}], 
    " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"AdjointRep", "[", 
     RowBox[{"algebra_", ",", "ideal_"}], "]"}], ":=", "\[IndentingNewLine]", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"commTable", ",", "decomp", ",", "nAlgebra", ",", "nIdeal"}], 
       "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"nAlgebra", " ", "=", " ", 
        RowBox[{"Length", "@", "algebra"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"nIdeal", " ", "=", " ", 
        RowBox[{"Length", "@", "ideal"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"Find", " ", "commutator", " ", "table"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"commTable", "=", 
        RowBox[{"AlgCommTable", "[", 
         RowBox[{"algebra", ",", "ideal", ",", 
          RowBox[{"ShowTable", "->", "False"}], ",", 
          RowBox[{"ShowOps", "->", "False"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Transpose", "/@", 
        RowBox[{"Table", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"decomp", "=", 
            RowBox[{"OpSumListDecomposition", "[", 
             RowBox[{
              RowBox[{"commTable", "[", 
               RowBox[{"[", 
                RowBox[{"i", ",", "j"}], "]"}], "]"}], ",", "ideal"}], 
             "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"Table", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Length", "@", "#"}], ">", "0"}], ",", 
                 RowBox[{"First", "@", 
                  RowBox[{"First", "@", "#"}]}], ",", "0"}], "]"}], "&"}], 
              "@", 
              RowBox[{"Select", "[", 
               RowBox[{"decomp", ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Last", "@", "#"}], "==", "k"}], "&"}]}], "]"}]}], 
             "\[IndentingNewLine]", ",", 
             RowBox[{"{", 
              RowBox[{"k", ",", "1", ",", "nIdeal"}], "}"}]}], "]"}]}], 
          "\[IndentingNewLine]", "\[IndentingNewLine]", ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", "nAlgebra"}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "1", ",", "nIdeal"}], "}"}]}], "]"}]}]}]}], 
     "\[IndentingNewLine]", "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.885973510457815*^9, 3.885973527841374*^9}, {
  3.885973568529988*^9, 3.885973589961737*^9}, {3.885973663938467*^9, 
  3.885973665169548*^9}, {3.885973730659767*^9, 3.885973742866043*^9}, {
  3.893383375760738*^9, 3.893383377653127*^9}, {3.906345896656458*^9, 
  3.906345944633699*^9}, {3.906346776809899*^9, 3.9063468468010097`*^9}, {
  3.906346885057802*^9, 3.9063468858007565`*^9}, {3.9063471008409014`*^9, 
  3.9063471020409*^9}, {3.906347345416955*^9, 3.906347345792954*^9}},
 CellLabel->
  "In[145]:=",ExpressionUUID->"70d00c9f-d69c-4b30-b452-4aa0ebc463c9"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Wei Norman expansion", "Section",
 CellChangeTimes->{{3.890447345339075*^9, 
  3.890447347961305*^9}},ExpressionUUID->"158d04e7-968c-4c95-8139-\
d256a7cd8b23"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "GetWNVars", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{"doubledCoords", "->", 
     RowBox[{"{", "}"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetWNVars", "[", 
    RowBox[{"algebra_", ",", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"u", "[", 
      RowBox[{"j", ",", "t"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "1", ",", 
       RowBox[{
        RowBox[{"Length", "@", "algebra"}], "+", 
        RowBox[{"Length", "@", 
         RowBox[{"OptionValue", "@", "doubledCoords"}]}]}]}], "}"}]}], 
    "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.899182245105835*^9, 3.899182282433007*^9}, {
  3.8992708162356358`*^9, 3.89927082022844*^9}},
 CellLabel->
  "In[147]:=",ExpressionUUID->"7b199531-1319-4593-a872-013d9804b410"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "GetWNMatrix", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"secondKind", "->", "False"}], ",", 
     RowBox[{"doubledCoords", "->", 
      RowBox[{"{", "}"}]}], ",", 
     RowBox[{"preCoord", "->", 
      RowBox[{"{", "}"}]}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"GetWNMatrix", "[", 
   RowBox[{"opAlgebra_", ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Number", " ", "of", " ", "elements", " ", "in", " ", "Lie", " ", 
       "algebra"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"nAlgebra", ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Number", " ", "of", " ", "doubled", " ", "elements"}], " ", 
       "*)"}], "\[IndentingNewLine]", "nDoubled", ",", "usingDoubledCoords", 
      ",", "coordIndices", ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Total", " ", "number", " ", "of", " ", "elemetns"}], " ", 
       "*)"}], "\[IndentingNewLine]", "nOps", ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"List", " ", "of", " ", "adjoint", " ", "opearators", " ", 
        SubscriptBox["ad", "Xj"]}], " ", "*)"}], "\[IndentingNewLine]", 
      "adXj", ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "If", " ", "using", " ", "exponential", " ", "coordinates", " ", "of", 
        " ", "the", " ", "first", " ", "kind"}], " ", "*)"}], 
      "\[IndentingNewLine]", "expuXj", ",", "Al", ",", "Xl", ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "If", " ", "using", " ", "exponential", " ", "coordiantes", " ", "of", 
        " ", "the", " ", "second", " ", "kind"}], " ", "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "A", ",", 
      "\[IndentingNewLine]", "uPrimeRHS", ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Equations", " ", "of", " ", "motion", " ", "and", " ", "initial", " ",
         "conditions"}], " ", "*)"}], "\[IndentingNewLine]", "eom", ",", "ic",
       ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"Pre", "-", 
        RowBox[{"positioned", " ", "coordinate"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", "\[Sigma]", ",", "\[Sigma]Doubled", ",", 
      "\[Sigma]Algebra", ",", "nPre"}], "}"}], ",", "\[IndentingNewLine]", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"nAlgebra", "=", 
      RowBox[{"Length", "@", "opAlgebra"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"nDoubled", "=", 
      RowBox[{"Length", "@", 
       RowBox[{"OptionValue", "@", "doubledCoords"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"usingDoubledCoords", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"nDoubled", ">", "0"}], ",", "True", ",", "False"}], "]"}]}], 
     ";", "\[IndentingNewLine]", 
     RowBox[{"coordIndices", "=", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"Range", "[", "nAlgebra", "]"}], ",", 
        RowBox[{"OptionValue", "@", "doubledCoords"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"nOps", "=", 
      RowBox[{"nAlgebra", "+", "nDoubled"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", 
         RowBox[{"OptionValue", "@", "preCoord"}]}], ">", "0"}], 
       "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"nPre", "=", "1"}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "\[Sigma]", " ", "Gives", " ", "the", " ", "index", " ", "relative", 
          " ", "to", " ", "the", " ", "doubled", " ", "coordinates"}], "*)"}], 
        RowBox[{"(*", 
         RowBox[{"Index", " ", "in", " ", "doubled", " ", "coordinates"}], 
         "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"\[Sigma]", "=", 
         RowBox[{"First", "@", 
          RowBox[{"OptionValue", "@", "preCoord"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Sigma]Doubled", "=", 
         RowBox[{"nAlgebra", "+", "\[Sigma]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Which", " ", "algebra", " ", "element", " ", "is", " ", 
          RowBox[{"this", "?"}]}], "*)"}], 
        RowBox[{"\[Sigma]Algebra", "=", 
         RowBox[{
          RowBox[{"OptionValue", "[", "doubledCoords", "]"}], "[", 
          RowBox[{"[", "\[Sigma]", "]"}], "]"}]}], ";"}], 
       "\[IndentingNewLine]", "\[IndentingNewLine]", ",", 
       "\[IndentingNewLine]", 
       RowBox[{"nPre", "=", "0"}]}], "\[IndentingNewLine]", "]"}], ";", "\n", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"adXj", "=", 
      RowBox[{"AdjointRep", "[", "opAlgebra", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{"usingDoubledCoords", ",", 
       RowBox[{"adXj", "=", 
        RowBox[{"Join", "[", 
         RowBox[{"adXj", ",", 
          RowBox[{
           RowBox[{
            RowBox[{"adXj", "[", 
             RowBox[{"[", "#", "]"}], "]"}], "&"}], "/@", 
           RowBox[{"OptionValue", "@", "doubledCoords"}]}]}], "]"}]}]}], 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "@", "secondKind"}], ",", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"A", "=", 
         RowBox[{"Integrate", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"MatrixExp", "[", 
            RowBox[{"\[Alpha]", " ", 
             RowBox[{"Sum", "[", 
              RowBox[{
               RowBox[{
                RowBox[{"u", "[", 
                 RowBox[{"j", ",", "t"}], "]"}], "*", 
                RowBox[{"adXj", "[", 
                 RowBox[{"[", "j", "]"}], "]"}]}], ",", 
               RowBox[{"{", 
                RowBox[{"j", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], "]"}],
            "\[IndentingNewLine]", ",", 
           RowBox[{"{", 
            RowBox[{"\[Alpha]", ",", "0", ",", "1"}], "}"}]}], "]"}]}], ";"}],
        "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"expuXj", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"MatrixExp", "[", 
            RowBox[{
             RowBox[{"u", "[", 
              RowBox[{"l", ",", "t"}], "]"}], " ", 
             RowBox[{"adXj", "[", 
              RowBox[{"[", "l", "]"}], "]"}]}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"l", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"Want", " ", 
          RowBox[{"{", 
           RowBox[{"1", ",", 
            SuperscriptBox["\[ExponentialE]", 
             RowBox[{
              SubscriptBox["u", "1"], 
              SubscriptBox["ad", "X1"]}]], ",", 
            RowBox[{
             SuperscriptBox["\[ExponentialE]", 
              RowBox[{
               SubscriptBox["u", "1"], 
               SubscriptBox["ad", "X1"]}]], 
             SuperscriptBox["\[ExponentialE]", 
              RowBox[{
               SubscriptBox["u", "2"], 
               SubscriptBox["ad", "X2"]}]]}], ",", ".."}], "}"}]}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"Al", "=", 
         RowBox[{"FoldList", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#1", ".", "#2"}], "&"}], ",", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"IdentityMatrix", "[", 
              RowBox[{"Length", "@", 
               RowBox[{"adXj", "[", 
                RowBox[{"[", "1", "]"}], "]"}]}], "]"}], ",", 
             RowBox[{"Sequence", "@@", 
              RowBox[{"expuXj", "[", 
               RowBox[{"[", 
                RowBox[{"1", ";;", 
                 RowBox[{"nOps", "-", "1"}]}], "]"}], "]"}]}]}], "}"}]}], 
          "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"nPre", ">", "0"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Al", "=", 
            RowBox[{
             RowBox[{
              RowBox[{"(", 
               RowBox[{
                RowBox[{"MatrixExp", "[", 
                 RowBox[{
                  RowBox[{"u", "[", 
                   RowBox[{"\[Sigma]Doubled", ",", "t"}], "]"}], " ", 
                  RowBox[{"adXj", "[", 
                   RowBox[{"[", "\[Sigma]Doubled", "]"}], "]"}]}], "]"}], ".",
                 "#"}], ")"}], "&"}], "/@", "Al"}]}], ";"}]}], 
         "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"Xl", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"k", "==", 
              RowBox[{"coordIndices", "[", 
               RowBox[{"[", "j", "]"}], "]"}]}], ",", "1", ",", "0"}], "]"}], 
           ",", 
           RowBox[{"{", 
            RowBox[{"j", ",", "1", ",", "nOps"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"k", ",", "1", ",", "nAlgebra"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Al", "\[CenterDot]", 
             SubscriptBox["X", "l"]}], " ", "\[IndentingNewLine]", "AlXl"}], 
           "=", 
           RowBox[{"Table", "[", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"Al", "[", 
               RowBox[{"[", "l", "]"}], "]"}], ".", 
              RowBox[{"Table", "[", 
               RowBox[{
                RowBox[{"KroneckerDelta", "[", 
                 RowBox[{"i", ",", "l"}], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"i", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ",", 
             "\[IndentingNewLine]", 
             RowBox[{"{", 
              RowBox[{"l", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"A", "=", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"AlXl", "[", 
               RowBox[{"[", "l", "]"}], "]"}], "[", 
              RowBox[{"[", "j", "]"}], "]"}], ",", 
             RowBox[{"{", 
              RowBox[{"j", ",", "1", ",", "nOps"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"l", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ";"}], 
         "\[IndentingNewLine]", "*)"}], "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"A", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Al", "[", 
               RowBox[{"[", "l", "]"}], "]"}], ".", 
              RowBox[{"Xl", "[", 
               RowBox[{"[", "l", "]"}], "]"}]}], ")"}], "[", 
            RowBox[{"[", "j", "]"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"j", ",", "1", ",", "nAlgebra"}], "}"}], ",", 
           RowBox[{"{", 
            RowBox[{"l", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ";"}]}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "A"}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->CompressedData["
1:eJxTTMoPSmViYGAQBmIQffIr/8oFrG8deyIObAPRSw7u2Aei695tOwCiLRbe
UV0IpF+vDdME0ac5/y5x5QbKa2jvANFz1Jr/gGiOHXI8bkBaLve1CIierB0h
BaKfbitSANE3nxQpguhVpmt5ZvC/dXxhKcQPou9u+S0Mot9bzBcD0Wx2E2RA
NNeeKmUQrcVc1Q2i3yxw6APRJil3p4DoyhXh00A0X8zFhSD6VqP7MhBtc2XV
ZRDtonXxDohmWH6+ayaQDspf1w2iP5+8MwNE23ucnwOir9wXWA+iVSe82g6i
7+TrvgfRumIXPoLoE4eqGNZYv3UMuFUHpgH/I5Ia
  "],
 CellLabel->
  "In[149]:=",ExpressionUUID->"9e301de1-69bd-4e66-94c0-08005383dfa7"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "WeiNormanEOM", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"initialConditions", "->", "False"}], ",", 
     RowBox[{"secondKind", "->", "False"}], ",", 
     RowBox[{"XjFromZero", "->", "False"}], ",", 
     RowBox[{"doubledCoords", "->", 
      RowBox[{"{", "}"}]}], ",", 
     RowBox[{"preCoord", "->", 
      RowBox[{"{", "}"}]}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"WeiNormanEOM", "[", 
   RowBox[{"opAlgebra_", ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Number", " ", "of", " ", "elements", " ", "in", " ", "Lie", " ", 
       "algebra"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
     "nAlgebra", ",", "nDoubled", ",", "usingDoubledCoords", ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", "A", ",", "A1", ",", "A2",
       ",", "AInv", ",", "\[IndentingNewLine]", "uPrimeRHS", ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "Equations", " ", "of", " ", "motion", " ", "and", " ", "initial", " ",
         "conditions"}], " ", "*)"}], "\[IndentingNewLine]", "eom", ",", "ic",
       ",", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Pre", "-", 
        RowBox[{"positioned", " ", "coordinate"}]}], "*)"}], 
      "\[IndentingNewLine]", "\[Sigma]", ",", "\[Sigma]Doubled", ",", 
      "\[Sigma]Algebra", ",", "nPre"}], "\[IndentingNewLine]", "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"nAlgebra", "=", 
      RowBox[{"Length", "@", "opAlgebra"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"nDoubled", "=", 
      RowBox[{"Length", "@", 
       RowBox[{"OptionValue", "@", "doubledCoords"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"usingDoubledCoords", "=", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"nDoubled", ">", "0"}], ",", "True", ",", "False"}], "]"}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", 
         RowBox[{"OptionValue", "@", "preCoord"}]}], ">", "0"}], 
       "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"nPre", "=", "1"}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
         "\[Sigma]", " ", "Gives", " ", "the", " ", "index", " ", "relative", 
          " ", "to", " ", "the", " ", "doubled", " ", "coordinates"}], "*)"}], 
        RowBox[{"(*", 
         RowBox[{"Index", " ", "in", " ", "doubled", " ", "coordinates"}], 
         "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"\[Sigma]", "=", 
         RowBox[{"First", "@", 
          RowBox[{"OptionValue", "@", "preCoord"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"\[Sigma]Doubled", "=", 
         RowBox[{"nAlgebra", "+", "\[Sigma]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{"Which", " ", "algebra", " ", "element", " ", "is", " ", 
          RowBox[{"this", "?"}]}], "*)"}], 
        RowBox[{"\[Sigma]Algebra", "=", 
         RowBox[{
          RowBox[{"OptionValue", "[", "doubledCoords", "]"}], "[", 
          RowBox[{"[", "\[Sigma]", "]"}], "]"}]}], ";"}], 
       "\[IndentingNewLine]", "\[IndentingNewLine]", ",", 
       "\[IndentingNewLine]", 
       RowBox[{"nPre", "=", "0"}]}], "\[IndentingNewLine]", "]"}], ";", "\n", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"A", "=", 
      RowBox[{"GetWNMatrix", "[", 
       RowBox[{"opAlgebra", ",", 
        RowBox[{"secondKind", "->", 
         RowBox[{"OptionValue", "@", "secondKind"}]}], ",", 
        RowBox[{"doubledCoords", "->", 
         RowBox[{"OptionValue", "@", "doubledCoords"}]}], ",", 
        RowBox[{"preCoord", "->", 
         RowBox[{"OptionValue", "@", "preCoord"}]}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"OptionValue", "@", "initialConditions"}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"ic", "=", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"OptionValue", "@", "XjFromZero"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"u", "[", 
              RowBox[{"l", ",", "0"}], "]"}], "==", "0"}], ",", 
            RowBox[{"{", 
             RowBox[{"l", ",", "0", ",", 
              RowBox[{"nAlgebra", "+", "nDoubled", "-", "1"}]}], "}"}]}], 
           "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"u", "[", 
              RowBox[{"l", ",", "0"}], "]"}], "==", "0"}], ",", 
            RowBox[{"{", 
             RowBox[{"l", ",", "1", ",", 
              RowBox[{"nAlgebra", "+", "nDoubled"}]}], "}"}]}], 
           "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
         "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", "usingDoubledCoords"}], ",", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"AInv", "=", 
         RowBox[{"Inverse", "@", "A"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"uPrimeRHS", "=", 
         RowBox[{"AInv", ".", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"a", "[", 
             RowBox[{"l", ",", "t"}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"l", ",", "1", ",", "nAlgebra"}], "}"}]}], "]"}]}]}], 
        ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"eom", " ", "=", " ", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"D", "[", 
             RowBox[{
              RowBox[{"u", "[", 
               RowBox[{"l", ",", "t"}], "]"}], ",", "t"}], "]"}], "==", 
            RowBox[{"uPrimeRHS", "[", 
             RowBox[{"[", "l", "]"}], "]"}]}], ",", 
           RowBox[{"{", 
            RowBox[{"l", ",", "1", ",", "nAlgebra"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"eom", " ", "=", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"OptionValue", "@", "initialConditions"}], ",", 
           RowBox[{"Flatten", "@", 
            RowBox[{"{", 
             RowBox[{"eom", ",", "ic"}], "}"}]}], ",", "eom"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"eom", " ", "=", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"OptionValue", "@", "XjFromZero"}], ",", 
           RowBox[{"eom", "/.", 
            RowBox[{
             RowBox[{"a_", "[", 
              RowBox[{"b_", ",", "t"}], "]"}], "->", 
             RowBox[{"a", "[", 
              RowBox[{
               RowBox[{"b", "-", "1"}], ",", "t"}], "]"}]}]}], ",", "eom"}], 
          "]"}]}], ";"}], "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"A1", "=", 
         RowBox[{"A", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"1", ";;", "nAlgebra"}], ",", 
            RowBox[{"1", ";;", "nAlgebra"}]}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"A2", "=", 
         RowBox[{"A", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"1", ";;", "nAlgebra"}], ",", 
            RowBox[{
             RowBox[{"nDoubled", "+", "1"}], ";;", 
             RowBox[{"nDoubled", "+", "nAlgebra"}]}]}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"nPre", ">", "1"}], ",", "\[IndentingNewLine]", 
          RowBox[{"A2", "=", 
           RowBox[{"A2", "+", 
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"KroneckerDelta", "[", 
                RowBox[{"j", ",", "\[Sigma]Algebra"}], "]"}], 
               RowBox[{"KroneckerDelta", "[", 
                RowBox[{"l", ",", "\[Sigma]Doubled"}], "]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{"j", ",", "1", ",", "nAlgebra"}], "}"}], ",", 
              RowBox[{"{", 
               RowBox[{"l", ",", 
                RowBox[{"nDoubled", "+", "1"}], ",", 
                RowBox[{"nDoubled", "+", "nAlgebra"}]}], "}"}]}], "]"}]}]}]}],
          "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"AInv", "=", 
         RowBox[{"{", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Inverse", "@", "A1"}], ",", "\[IndentingNewLine]", 
           RowBox[{"Inverse", "@", "A2"}]}], "\[IndentingNewLine]", "}"}]}], 
        ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"uPrimeRHS", "=", 
         RowBox[{"{", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"AInv", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ".", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"a", "[", 
               RowBox[{"l", ",", "t"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"l", ",", "1", ",", "nAlgebra"}], "}"}]}], "]"}]}], 
           ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"AInv", "[", 
             RowBox[{"[", "2", "]"}], "]"}], ".", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{"a", "[", 
               RowBox[{"l", ",", "t"}], "]"}], ",", 
              RowBox[{"{", 
               RowBox[{"l", ",", "1", ",", "nAlgebra"}], "}"}]}], "]"}]}]}], 
          "\[IndentingNewLine]", "}"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"eom", " ", "=", 
         RowBox[{"{", "\[IndentingNewLine]", " ", 
          RowBox[{
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"D", "[", 
               RowBox[{
                RowBox[{"u", "[", 
                 RowBox[{"l", ",", "t"}], "]"}], ",", "t"}], "]"}], "==", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"l", "<=", "nAlgebra"}], ",", 
                RowBox[{
                 RowBox[{"uPrimeRHS", "[", 
                  RowBox[{"[", "1", "]"}], "]"}], "[", 
                 RowBox[{"[", "l", "]"}], "]"}], ",", "0"}], "]"}]}], ",", 
             RowBox[{"{", 
              RowBox[{"l", ",", "1", ",", 
               RowBox[{"nAlgebra", "+", "nDoubled"}]}], "}"}]}], "]"}], ",", 
           "\[IndentingNewLine]", " ", 
           RowBox[{"Table", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"D", "[", 
               RowBox[{
                RowBox[{"u", "[", 
                 RowBox[{"l", ",", "t"}], "]"}], ",", "t"}], "]"}], "==", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"l", "<=", "nDoubled"}], ",", "0", ",", 
                RowBox[{
                 RowBox[{"uPrimeRHS", "[", 
                  RowBox[{"[", "2", "]"}], "]"}], "[", 
                 RowBox[{"[", 
                  RowBox[{"l", "-", "nDoubled"}], "]"}], "]"}]}], "]"}]}], 
             ",", 
             RowBox[{"{", 
              RowBox[{"l", ",", "1", ",", 
               RowBox[{"nAlgebra", "+", "nDoubled"}]}], "}"}]}], "]"}]}], 
          "\[IndentingNewLine]", "}"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"eom", " ", "=", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"OptionValue", "@", "initialConditions"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"Flatten", "@", 
              RowBox[{"{", 
               RowBox[{"#", ",", "ic"}], "}"}]}], "&"}], "/@", "eom"}], ",", 
           "eom"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"eom", " ", "=", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"OptionValue", "@", "XjFromZero"}], ",", 
           RowBox[{"eom", "/.", 
            RowBox[{
             RowBox[{"a_", "[", 
              RowBox[{"b_", ",", "t"}], "]"}], "->", 
             RowBox[{"a", "[", 
              RowBox[{
               RowBox[{"b", "-", "1"}], ",", "t"}], "]"}]}]}], ",", "eom"}], 
          "]"}]}], ";"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"!", "usingDoubledCoords"}], ",", "eom", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Det", "@", "A1"}], ",", 
           RowBox[{"eom", "[", 
            RowBox[{"[", "1", "]"}], "]"}]}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Det", "@", "A2"}], ",", 
           RowBox[{"eom", "[", 
            RowBox[{"[", "2", "]"}], "]"}]}], "}"}]}], "}"}]}], "]"}]}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}]}]}], "Input",
 CellChangeTimes->CompressedData["
1:eJwdyVtIU3EAx/HD2ECduBAP6YvkJTNEGxMvE1GPD85EUMvLCufDdN4vzVta
FmMqmYpIOt3ZMvPyYGHBiBQ9D17ATVQU5g0SNVAswYNraBIWtN//4ceHH98A
dc0DjYCiqNuuQZntIPbl3zPGUCpLhV4P97Lh2ddfRP3abAEcvhuhhjVL7yvh
p7SqBug49OuG0W9NxNDBGAN0C9QZoV2+MdDn0pnlY4U9nrYVKPb0XoUyue+Y
WMAzaqF5Ei6ndz7KE/KM/UtTAbRxzzTw1XTKE9ixNHNzRMQzpnOFPww26oMg
Pb4bDEuUceEpYp75SdmJJ45CBfxuMVXD/o9tjVAplL6AEaFUO0zquuyEmSdb
b6CAZoegW1HHKGTrRRPwOO2DBbq3s3NQd7gWonWZXOcg3vtmEBglPNMbJBHB
1zqJAs7/4+7Dx+m/y2ALZ6mA1k36CtZ6s39gMi2Vsy7DplREL86ZASejFrKg
x956DuRuRCvhresEFfm6H8RsTbwaMu9UhbA8J0wLqf2qWvj5cvg5NPhetMBc
be4svNMauQh9niZaobnVRKTz9ZtwJyl/m/TK7iN4sDBwCovNzU4oHTon/gc1
nh0y
  "],
 CellLabel->
  "In[151]:=",ExpressionUUID->"84aaa931-f17a-4339-8b2c-421a15aab661"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "SimulateDoubledEOM", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "SimulateDoubledEOM", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"singularity\[Epsilon]", "->", "0.1"}], ",", 
     RowBox[{"maxSwaps", "->", "5"}]}], "}"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SimulateDoubledEOM", "[", 
   RowBox[{"doubledEOM_", ",", "coeffs_", ",", "tf_", ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
     "det1", ",", "eom1", ",", "det2", ",", "eom2", ",", 
      "\[IndentingNewLine]", "whichEOM", ",", "eomCurrent", ",", "detCurrent",
       ",", "\[IndentingNewLine]", "nOps", ",", "vars", ",", "ic", ",", 
      "\[IndentingNewLine]", "sol", ",", "solList", ",", "tStopList", ",", 
      "\[IndentingNewLine]", "nSwaps", ",", "tStopped", ",", "tStart", ",", 
      "\[IndentingNewLine]", "solsGrouped", ",", "solsPiecewise"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "}"}], ",", 
    "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"det1", "=", 
      RowBox[{"doubledEOM", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"eom1", "=", 
      RowBox[{
       RowBox[{"doubledEOM", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "2"}], "]"}], "]"}], "//.", "coeffs"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"det2", "=", 
      RowBox[{"doubledEOM", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"eom2", "=", 
      RowBox[{
       RowBox[{"doubledEOM", "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "2"}], "]"}], "]"}], "//.", "coeffs"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"nOps", "=", 
      RowBox[{"Length", "@", "eom1"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"vars", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"u", "[", 
         RowBox[{"j", ",", "t"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"ic", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"u", "[", 
          RowBox[{"j", ",", "0"}], "]"}], "==", "0"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"whichEOM", "=", "1"}], ";", "\[IndentingNewLine]", 
     RowBox[{"nSwaps", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"tStart", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"tStopped", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"tStopList", "=", 
      RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"solList", "=", 
      RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"While", "[", 
      RowBox[{
       RowBox[{"tStopped", "<", "tf"}], ",", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Beginning simulation \>\"", "<>", 
          RowBox[{"ToString", "@", 
           RowBox[{"(", 
            RowBox[{"nSwaps", "+", "1"}], ")"}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"Stop", " ", "if", " ", 
          RowBox[{"we", "'"}], "ve", " ", "reached", " ", "maximum", " ", 
          "number", " ", "of", " ", "swaps"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"nSwaps", "==", 
           RowBox[{"OptionValue", "@", "maxSwaps"}]}], ",", 
          RowBox[{
           RowBox[{
           "Print", "[", 
            "\"\<Maximum coordinate swaps reached! Aborting.\>\"", "]"}], ";", 
           RowBox[{"Break", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]",
         "\[IndentingNewLine]", 
        RowBox[{"eomCurrent", "=", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"whichEOM", "==", "1"}], ",", "eom1", ",", "eom2"}], 
          "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"detCurrent", "=", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"whichEOM", "==", "1"}], ",", "det1", ",", "det2"}], 
          "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"tStopped", "=", "tf"}], ";", "\[IndentingNewLine]", 
        RowBox[{"sol", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{
             RowBox[{"Hold", "[", "\[IndentingNewLine]", 
              RowBox[{"NDSolve", "[", 
               RowBox[{
                RowBox[{"Join", "[", 
                 RowBox[{"eomCurrent", ",", "ic", ",", 
                  RowBox[{"{", 
                   RowBox[{"WhenEvent", "[", 
                    RowBox[{
                    RowBox[{"da", "<", 
                    RowBox[{"OptionValue", "@", "singularity\[Epsilon]"}]}], 
                    ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"tStopped", "=", "t"}], ",", 
                    RowBox[{"nSwaps", "=", 
                    RowBox[{"nSwaps", "+", "1"}]}], ",", 
                    RowBox[{"Print", "[", 
                    RowBox[{"\"\<Swapping at t=\>\"", ",", "t"}], "]"}], ",", 
                    "\"\<StopIntegration\>\""}], "}"}]}], "]"}], "}"}]}], 
                 "]"}], ",", "vars", ",", 
                RowBox[{"{", 
                 RowBox[{"t", ",", "tStart", ",", "tf"}], "}"}]}], "]"}], 
              "\[IndentingNewLine]", "]"}], "/.", 
             RowBox[{"da", "->", "detCurrent"}]}], "//", "ReleaseHold"}], 
           ")"}], "//", "Flatten"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"tStopList", "=", 
         RowBox[{"Append", "[", 
          RowBox[{"tStopList", ",", "tStopped"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"solList", "=", 
         RowBox[{"Append", "[", 
          RowBox[{"solList", ",", "sol"}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"tStopped", "<", "tf"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"tStart", "=", "tStopped"}], ";", "\[IndentingNewLine]", 
           RowBox[{"whichEOM", "=", 
            RowBox[{"1", "-", "whichEOM"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"ic", "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"u", "[", 
                RowBox[{"j", ",", "tStart"}], "]"}], "==", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"u", "[", 
                   RowBox[{"j", ",", "t"}], "]"}], "/.", "sol"}], "/.", 
                 RowBox[{"t", "->", "tStopped"}]}], ")"}]}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}]}]}], 
         "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"{", 
       RowBox[{"solList", ",", "tStopList"}], "}"}], "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"solsGrouped", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Last", "/@", "#"}], "&"}], "/@", 
       RowBox[{"(", 
        RowBox[{"Transpose", "@", "solList"}], ")"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"solsPiecewise", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{
             RowBox[{"solsGrouped", "[", 
              RowBox[{"[", 
               RowBox[{"i", ",", "j"}], "]"}], "]"}], "/.", 
             RowBox[{"t", "->", "T"}]}], ",", 
            RowBox[{"T", "<", 
             RowBox[{"tStopList", "[", 
              RowBox[{"[", "j", "]"}], "]"}]}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "1", ",", 
            RowBox[{"nSwaps", "+", "1"}]}], "}"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"solsPiecewise", "=", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Hold", "[", 
           RowBox[{"Function", "[", 
            RowBox[{"T", ",", 
             RowBox[{"Piecewise", "[", "fVals", "]"}]}], "]"}], "]"}], "/.", 
          RowBox[{"fVals", "->", 
           RowBox[{"solsPiecewise", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "nOps"}], "}"}]}], "]"}], "//", 
       "ReleaseHold"}]}]}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.898226690680499*^9, 3.898226746082874*^9}, {
   3.898226777282542*^9, 3.89822703492256*^9}, {3.898227074710387*^9, 
   3.898227078898834*^9}, {3.898227162572482*^9, 3.898227274396482*^9}, {
   3.898227622538629*^9, 3.898227701292395*^9}, {3.898227761597101*^9, 
   3.89822803366721*^9}, {3.898228071820947*^9, 3.898228074908541*^9}, {
   3.8982281115359097`*^9, 3.898228259241872*^9}, {3.898228311825507*^9, 
   3.898228347568472*^9}, {3.8982284729166183`*^9, 3.898228477218493*^9}, {
   3.898228510400764*^9, 3.898228512745958*^9}, {3.89822870021317*^9, 
   3.898228870806484*^9}, {3.898229180308028*^9, 3.898229181248625*^9}, 
   3.8982292906397347`*^9, {3.8982314878866634`*^9, 3.898231553352381*^9}, {
   3.898231618480467*^9, 3.898231762563476*^9}, {3.898231802780238*^9, 
   3.898231815112603*^9}, {3.898231945251475*^9, 3.898231949037293*^9}, {
   3.898232082011765*^9, 3.898232083245773*^9}, {3.898240892430146*^9, 
   3.898240929381622*^9}, {3.8985821614136877`*^9, 3.898582183090397*^9}},
 CellLabel->
  "In[153]:=",ExpressionUUID->"7e63edb1-c515-4c3a-8623-be614db9db76"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "SimulateDoubledEOM2", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"singularity\[Epsilon]", "->", "0.1"}], ",", 
     RowBox[{"maxSwaps", "->", "5"}], ",", 
     RowBox[{"maxDerivative", "->", "10"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SimulateDoubledEOM2", "[", 
   RowBox[{"doubledEOM_", ",", "coeffs_", ",", "tf_", ",", 
    RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], ":=", 
  RowBox[{"Module", "[", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
     "det1", ",", "eom1", ",", "det2", ",", "eom2", ",", 
      "\[IndentingNewLine]", "whichEOM", ",", "eomCurrent", ",", "detCurrent",
       ",", "\[IndentingNewLine]", "nOps", ",", "vars", ",", "ic", ",", 
      "\[IndentingNewLine]", "sol", ",", "solList", ",", "tStopList", ",", 
      "\[IndentingNewLine]", "nSwaps", ",", "tStopped", ",", "tStart", ",", 
      "\[IndentingNewLine]", "solsGrouped", ",", "solsPiecewise", ",", 
      "\[IndentingNewLine]", "maxAbsDetCond"}], "\[IndentingNewLine]", "}"}], 
    ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"det1", "=", 
      RowBox[{"doubledEOM", "[", 
       RowBox[{"[", 
        RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"eom1", "=", 
      RowBox[{
       RowBox[{"doubledEOM", "[", 
        RowBox[{"[", 
         RowBox[{"1", ",", "2"}], "]"}], "]"}], "//.", "coeffs"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"det2", "=", 
      RowBox[{"doubledEOM", "[", 
       RowBox[{"[", 
        RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"eom2", "=", 
      RowBox[{
       RowBox[{"doubledEOM", "[", 
        RowBox[{"[", 
         RowBox[{"2", ",", "2"}], "]"}], "]"}], "//.", "coeffs"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"nOps", "=", 
      RowBox[{"Length", "@", "eom1"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"vars", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"u", "[", 
         RowBox[{"j", ",", "t"}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"ic", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"u", "[", 
          RowBox[{"j", ",", "0"}], "]"}], "==", "0"}], ",", 
        RowBox[{"{", 
         RowBox[{"j", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"whichEOM", "=", "1"}], ";", "\[IndentingNewLine]", 
     RowBox[{"nSwaps", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"tStart", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"tStopped", "=", "0"}], ";", "\[IndentingNewLine]", 
     RowBox[{"tStopList", "=", 
      RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"solList", "=", 
      RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"While", "[", 
      RowBox[{
       RowBox[{"tStopped", "<", "tf"}], ",", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Print", "[", 
         RowBox[{"\"\<Beginning simulation \>\"", "<>", 
          RowBox[{"ToString", "@", 
           RowBox[{"(", 
            RowBox[{"nSwaps", "+", "1"}], ")"}]}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"Stop", " ", "if", " ", 
          RowBox[{"we", "'"}], "ve", " ", "reached", " ", "maximum", " ", 
          "number", " ", "of", " ", "swaps"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"nSwaps", "==", 
           RowBox[{"OptionValue", "@", "maxSwaps"}]}], ",", 
          RowBox[{
           RowBox[{
           "Print", "[", 
            "\"\<Maximum coordinate swaps reached! Aborting.\>\"", "]"}], ";", 
           RowBox[{"Break", "[", "]"}]}]}], "]"}], ";", "\[IndentingNewLine]",
         "\[IndentingNewLine]", 
        RowBox[{"eomCurrent", "=", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"whichEOM", "==", "1"}], ",", "eom1", ",", "eom2"}], 
          "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"detCurrent", "=", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"whichEOM", "==", "1"}], ",", "det1", ",", "det2"}], 
          "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"maxAbsDetCond", "=", 
         RowBox[{"Max", "@", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"Abs", "@", 
             RowBox[{"u", "[", 
              RowBox[{"j", ",", "t"}], "]"}]}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"Print", "[", "maxAbsDetCond", "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"tStopped", "=", "tf"}], ";", "\[IndentingNewLine]", 
        RowBox[{"sol", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Hold", "[", "\[IndentingNewLine]", 
               RowBox[{"NDSolve", "[", 
                RowBox[{
                 RowBox[{"Join", "[", 
                  RowBox[{"eomCurrent", ",", "ic", ",", 
                   RowBox[{"{", 
                    RowBox[{"WhenEvent", "[", 
                    RowBox[{
                    RowBox[{"da", "<", 
                    RowBox[{"OptionValue", "@", "singularity\[Epsilon]"}]}], 
                    ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"tStopped", "=", "t"}], ",", 
                    RowBox[{"nSwaps", "=", 
                    RowBox[{"nSwaps", "+", "1"}]}], ",", 
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<Approaching singularity, swapping at t=\>\"", ",", 
                    "t"}], "]"}], ",", "\"\<StopIntegration\>\""}], "}"}]}], 
                    "]"}], "}"}], ",", 
                   RowBox[{"{", 
                    RowBox[{"WhenEvent", "[", 
                    RowBox[{
                    RowBox[{"detcond", ">", 
                    RowBox[{"OptionValue", "@", "maxDerivative"}]}], ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"tStopped", "=", "t"}], ",", 
                    RowBox[{"nSwaps", "=", 
                    RowBox[{"nSwaps", "+", "1"}]}], ",", 
                    RowBox[{"Print", "[", 
                    RowBox[{
                    "\"\<Derivative too large, swapping at t=\>\"", ",", 
                    "t"}], "]"}], ",", 
                    RowBox[{"Print", "[", "detcond", "]"}], ",", 
                    "\"\<StopIntegration\>\""}], "}"}]}], "]"}], "}"}]}], 
                  "]"}], ",", "vars", ",", 
                 RowBox[{"{", 
                  RowBox[{"t", ",", "tStart", ",", "tf"}], "}"}]}], "]"}], 
               "\[IndentingNewLine]", "]"}], "/.", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"da", "->", "detCurrent"}], ",", 
                RowBox[{"detcond", "->", "maxAbsDetCond"}]}], "}"}]}], ")"}], 
            "//", "ReleaseHold"}], ")"}], "//", "Flatten"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"tStopList", "=", 
         RowBox[{"Append", "[", 
          RowBox[{"tStopList", ",", "tStopped"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"solList", "=", 
         RowBox[{"Append", "[", 
          RowBox[{"solList", ",", "sol"}], "]"}]}], ";", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"tStopped", "<", "tf"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"tStart", "=", "tStopped"}], ";", "\[IndentingNewLine]", 
           RowBox[{"whichEOM", "=", 
            RowBox[{"1", "-", "whichEOM"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"ic", "=", 
            RowBox[{"Table", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"u", "[", 
                RowBox[{"j", ",", "tStart"}], "]"}], "==", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"u", "[", 
                   RowBox[{"j", ",", "t"}], "]"}], "/.", "sol"}], "/.", 
                 RowBox[{"t", "->", "tStopped"}]}], ")"}]}], ",", 
              RowBox[{"{", 
               RowBox[{"j", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}]}]}], 
         "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{"{", 
       RowBox[{"solList", ",", "tStopList"}], "}"}], "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"solsGrouped", "=", 
      RowBox[{
       RowBox[{
        RowBox[{"Last", "/@", "#"}], "&"}], "/@", 
       RowBox[{"(", 
        RowBox[{"Transpose", "@", "solList"}], ")"}]}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"solsPiecewise", "=", 
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{
             RowBox[{"solsGrouped", "[", 
              RowBox[{"[", 
               RowBox[{"i", ",", "j"}], "]"}], "]"}], "/.", 
             RowBox[{"t", "->", "T"}]}], ",", 
            RowBox[{"T", "<", 
             RowBox[{"tStopList", "[", 
              RowBox[{"[", "j", "]"}], "]"}]}]}], "}"}], ",", 
          RowBox[{"{", 
           RowBox[{"j", ",", "1", ",", 
            RowBox[{"nSwaps", "+", "1"}]}], "}"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "1", ",", "nOps"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"solsPiecewise", "=", 
      RowBox[{
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Hold", "[", 
           RowBox[{"Function", "[", 
            RowBox[{"T", ",", 
             RowBox[{"Piecewise", "[", "fVals", "]"}]}], "]"}], "]"}], "/.", 
          RowBox[{"fVals", "->", 
           RowBox[{"solsPiecewise", "[", 
            RowBox[{"[", "i", "]"}], "]"}]}]}], ",", 
         RowBox[{"{", 
          RowBox[{"i", ",", "1", ",", "nOps"}], "}"}]}], "]"}], "//", 
       "ReleaseHold"}]}]}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 CellChangeTimes->{{3.898583884783804*^9, 3.898583889336009*^9}, {
   3.898583964559538*^9, 3.8985841137415376`*^9}, {3.8985845391728945`*^9, 
   3.89858454175156*^9}, {3.89858457898197*^9, 3.898584608634087*^9}, {
   3.898584659746016*^9, 3.898584714661352*^9}, 3.898584752447588*^9, {
   3.8985855920150766`*^9, 3.898585648830696*^9}},
 CellLabel->
  "In[156]:=",ExpressionUUID->"218fe326-3166-4bcf-8b2e-c1b4f377756c"]
}, Open  ]]
}, Open  ]]
},
WindowSize->{606, 732.75},
WindowMargins->{{Automatic, 0}, {Automatic, 0}},
Magnification:>1.2 Inherited,
FrontEndVersion->"14.0 for Microsoft Windows (64-bit) (December 12, 2023)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"79d22e74-d627-4740-b48c-56651468dcca"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 161, 3, 117, "Title",ExpressionUUID->"36657420-c6b4-2e4b-8cad-d0e8ee672813"],
Cell[744, 27, 674, 14, 147, "Text",ExpressionUUID->"c959c9c9-15f9-664c-9757-80c5fe998eba"],
Cell[CellGroupData[{
Cell[1443, 45, 203, 4, 81, "Section",ExpressionUUID->"f6d4f324-b6b9-4880-85ed-5063cb5c18b3"],
Cell[1649, 51, 630, 11, 94, "Text",ExpressionUUID->"dfe74e1f-de29-4b06-8693-4d33c8ae87c9"],
Cell[CellGroupData[{
Cell[2304, 66, 349, 7, 33, "Input",ExpressionUUID->"f56180c4-964e-411a-858f-bd7682b56cf3",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 InitializationGroup->True],
Cell[2656, 75, 117602, 3022, 12322, "Input",ExpressionUUID->"1cc186d6-fdd0-4027-b5d4-5d77ddc45b13",
 CellGroupingRules->{GroupTogetherGrouping, 10000.},
 InitializationGroup->True]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[120307, 3103, 156, 3, 81, "Section",ExpressionUUID->"bbcf0f62-85ed-4f4f-bcec-da47360332b9"],
Cell[CellGroupData[{
Cell[120488, 3110, 163, 3, 64, "Subsection",ExpressionUUID->"f948ffcc-e1ce-46d5-97a1-55041fda22c9"],
Cell[120654, 3115, 1025, 22, 129, "Input",ExpressionUUID->"d69e0537-72d1-4906-b66a-83d91b73f5b3"]
}, Open  ]],
Cell[CellGroupData[{
Cell[121716, 3142, 155, 3, 64, "Subsection",ExpressionUUID->"ef77efab-3c4b-4cbb-951a-4c5ce2fd200c"],
Cell[121874, 3147, 1182, 27, 201, "Input",ExpressionUUID->"9f734630-0b05-48df-9129-eacd1fc13b8a"],
Cell[123059, 3176, 1802, 35, 263, "Input",ExpressionUUID->"85103725-06b0-4380-885c-5b57389a1270"]
}, Open  ]],
Cell[CellGroupData[{
Cell[124898, 3216, 158, 3, 64, "Subsection",ExpressionUUID->"94414981-0235-4b48-aa9e-32a1beca9644"],
Cell[125059, 3221, 1741, 33, 240, "Input",ExpressionUUID->"92d442eb-9250-4304-ad76-cc46918b34e7"],
Cell[126803, 3256, 1025, 26, 149, "Input",ExpressionUUID->"05153360-b700-406a-9c5e-d90e7156ec9f"]
}, Open  ]],
Cell[CellGroupData[{
Cell[127865, 3287, 164, 3, 64, "Subsection",ExpressionUUID->"077d87ef-e359-984f-b96e-8c7ce196257f"],
Cell[128032, 3292, 898, 21, 149, "Input",ExpressionUUID->"878f9bd8-dd0a-e648-af84-206a7187e322"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[128979, 3319, 171, 3, 81, "Section",ExpressionUUID->"65506463-ab67-4ece-9806-60189c288b3e"],
Cell[CellGroupData[{
Cell[129175, 3326, 168, 3, 64, "Subsection",ExpressionUUID->"43203384-45b1-48bf-b9ab-0446bd72aa09"],
Cell[129346, 3331, 10486, 250, 1587, "Input",ExpressionUUID->"28dbff42-8e2e-48c5-b9a7-757f8c408665"]
}, Open  ]],
Cell[CellGroupData[{
Cell[139869, 3586, 161, 3, 64, "Subsection",ExpressionUUID->"cc134990-d28e-41b9-b778-1cdc3c442e73"],
Cell[140033, 3591, 7752, 167, 1115, "Input",ExpressionUUID->"3f2d6b1c-f09c-4be6-91a0-029930531cbc"]
}, Open  ]],
Cell[CellGroupData[{
Cell[147822, 3763, 170, 3, 64, "Subsection",ExpressionUUID->"2aee7465-ec7c-4239-bd15-1d1e0fc98a3d"],
Cell[147995, 3768, 7510, 157, 1201, "Input",ExpressionUUID->"852c7d7e-aecf-41f8-b3fa-1e7932f989ac"]
}, Open  ]],
Cell[CellGroupData[{
Cell[155542, 3930, 169, 3, 64, "Subsection",ExpressionUUID->"ff8fdb72-1ff2-4c9a-bca1-f79e0d667c0d"],
Cell[155714, 3935, 10303, 221, 1554, "Input",ExpressionUUID->"7529e6e4-f4be-45a0-b75e-5a0abc089166"]
}, Open  ]],
Cell[CellGroupData[{
Cell[166054, 4161, 210, 4, 64, "Subsection",ExpressionUUID->"186ef421-dfcc-40ba-a495-41c4fcead439"],
Cell[166267, 4167, 2052, 45, 217, "Input",ExpressionUUID->"963fde70-56d7-47a2-930e-7db3a31565ee"],
Cell[168322, 4214, 4166, 103, 611, "Input",ExpressionUUID->"e744eaaa-0894-4ce4-9d0a-6ec1cdc5ee22"]
}, Open  ]],
Cell[CellGroupData[{
Cell[172525, 4322, 289, 4, 64, "Subsection",ExpressionUUID->"1d9dd80e-c79b-4f9b-b22d-cca54a8b8884"],
Cell[172817, 4328, 4080, 96, 742, "Input",ExpressionUUID->"0c22332f-fbf5-4d1c-bfcc-2dc14fcff68b"]
}, Open  ]],
Cell[CellGroupData[{
Cell[176934, 4429, 170, 3, 64, "Subsection",ExpressionUUID->"27c9be0d-9075-470b-9bf4-787988b9f0d4"],
Cell[177107, 4434, 3688, 84, 582, "Input",ExpressionUUID->"70d00c9f-d69c-4b30-b452-4aa0ebc463c9"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[180844, 4524, 165, 3, 81, "Section",ExpressionUUID->"158d04e7-968c-4c95-8139-d256a7cd8b23"],
Cell[181012, 4529, 909, 26, 126, "Input",ExpressionUUID->"7b199531-1319-4593-a872-013d9804b410"],
Cell[181924, 4557, 12086, 291, 2106, "Input",ExpressionUUID->"9e301de1-69bd-4e66-94c0-08005383dfa7"],
Cell[194013, 4850, 14177, 338, 2546, "Input",ExpressionUUID->"84aaa931-f17a-4339-8b2c-421a15aab661"],
Cell[208193, 5190, 10275, 237, 1861, "Input",ExpressionUUID->"7e63edb1-c515-4c3a-8623-be614db9db76"],
Cell[218471, 5429, 11086, 261, 2158, "Input",ExpressionUUID->"218fe326-3166-4bcf-8b2e-c1b4f377756c"]
}, Open  ]]
}, Open  ]]
}
]
*)

